<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Call Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            position: relative;
        }
        .admin-link {
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            background-color: #3498db;
            padding: 5px 15px;
            border-radius: 4px;
        }
        .admin-link:hover {
            background-color: #2980b9;
        }
        .status-check {
            margin: 30px auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 600px;
        }
        form {
            background-color: white;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }
        button:hover {
            background-color: #2980b9;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #27ae60;
            color: white;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        #adminPanel {
            display: none;
            margin-top: 30px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .status-pending {
            color: #e74c3c;
            font-weight: bold;
        }
        .status-inprocess {
            color: #f39c12;
            font-weight: bold;
        }
        .status-closed {
            color: #27ae60;
            font-weight: bold;
        }
        #passwordModal, #ticketModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
        }
        .modal-content h2 {
            margin-top: 0;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }
        .ticket-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .ticket-details p {
            margin: 10px 0;
        }
        .ticket-id {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    
    <div id="passwordModal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <p>Please enter the admin password:</p>
            <input type="password" id="adminPasswordInput" placeholder="Enter password">
            <button onclick="checkAdminPassword()">Login</button>
        </div>
    </div>

    <div id="ticketModal">
        <div class="modal-content">
            <h2>Service Request Status</h2>
            <div id="ticketDetails" class="ticket-details">
                <!-- Ticket details will be shown here -->
            </div>
            <button onclick="closeTicketModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <header>
        <h1>Service Call Management System</h1>
        <a href="#" class="admin-link" onclick="showAdminLogin()">Admin Login</a>
    </header>

    <div class="container">
        <!-- Main Service Request Form -->
        <form id="serviceRequestForm">
            <h2>New Service Request</h2>
            <div class="form-group">
                <label for="customerName">Customer Name*</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-group">
                <label for="companyName">Company Name</label>
                <input type="text" id="companyName">
            </div>
            <div class="form-group">
                <label for="contactNumber">Contact Number*</label>
                <input type="tel" id="contactNumber" required>
            </div>
            <div class="form-group">
                <label for="email">Email*</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="address">Address*</label>
                <textarea id="address" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="deviceType">Device Type*</label>
                <select id="deviceType" required>
                    <option value="">Select Device</option>
                    <option value="Desktop">Desktop Computer</option>
                    <option value="Laptop">Laptop</option>
                    <option value="Printer">Printer</option>
                    <option value="Server">Server</option>
                    <option value="Network">Network Equipment</option>
                    <option value="Other">Other Peripheral</option>
                </select>
            </div>
            <div class="form-group">
                <label for="brand">Brand/Model</label>
                <input type="text" id="brand">
            </div>
            <div class="form-group">
                <label for="serialNumber">Serial Number</label>
                <input type="text" id="serialNumber">
            </div>
            <div class="form-group">
                <label for="issueDescription">Issue Description*</label>
                <textarea id="issueDescription" rows="4" required></textarea>
            </div>
            <div class="form-group">
                <label for="serviceType">Service Type*</label>
                <select id="serviceType" required>
                    <option value="">Select Service Type</option>
                    <option value="AMC">AMC (Annual Maintenance Contract)</option>
                    <option value="Chargeable">Chargeable Service</option>
                    <option value="Warranty">Warranty Service</option>
                </select>
            </div>
            <div class="form-group">
                <label for="priority">Priority*</label>
                <select id="priority" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>
            <button type="submit" id="submitBtn">Submit Service Request</button>
        </form>

        <!-- Status Check Form -->
        <div class="status-check">
            <h2>Check Your Service Request Status</h2>
            <div class="form-group">
                <label for="ticketNumber">Enter your Ticket Number (SR-XXXX):</label>
                <input type="text" id="ticketNumber" placeholder="SR-XXXX">
            </div>
            <button onclick="checkTicketStatus()">Check Status</button>
        </div>

        <!-- Admin Panel (hidden by default) -->
        <div id="adminPanel">
            <div class="tabs">
                <div class="tab active" onclick="openAdminTab('calls')">Service Calls</div>
                <div class="tab" onclick="openAdminTab('engineers')">Engineers</div>
                <div class="tab" onclick="openAdminTab('assign')">Assign Calls</div>
                <div class="tab" onclick="openAdminTab('reports')">Reports</div>
                <div class="tab" onclick="openAdminTab('database')">Database</div>
            </div>

            <!-- Service Calls Tab -->
            <div id="adminCalls" class="tab-content active">
                <h2>Service Calls Management</h2>
                <div>
                    <label for="callStatusFilter">Filter by Status:</label>
                    <select id="callStatusFilter" onchange="filterAdminCalls()">
                        <option value="All">All</option>
                        <option value="Pending">Pending</option>
                        <option value="In Process">In Process</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <table id="adminCallTable">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Device</th>
                            <th>Issue</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminCallTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Engineers Tab -->
            <div id="adminEngineers" class="tab-content">
                <h2>Engineers Management</h2>
                <form id="engineerForm" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="engineerName">Engineer Name*</label>
                        <input type="text" id="engineerName" required>
                    </div>
                    <div class="form-group">
                        <label for="engineerContact">Contact Number</label>
                        <input type="tel" id="engineerContact">
                    </div>
                    <div class="form-group">
                        <label for="engineerEmail">Email</label>
                        <input type="email" id="engineerEmail">
                    </div>
                    <div class="form-group">
                        <label for="engineerSpecialization">Specialization</label>
                        <input type="text" id="engineerSpecialization" placeholder="Comma separated (e.g., Laptop, Printer)">
                    </div>
                    <button type="submit">Add Engineer</button>
                </form>
                <table id="engineerTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Specialization</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="engineerTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Assign Calls Tab -->
            <div id="adminAssign" class="tab-content">
                <h2>Assign Service Calls</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>Unassigned Calls</h3>
                        <table id="adminUnassignedTable">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Ticket ID</th>
                                    <th>Customer</th>
                                    <th>Device</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody id="adminUnassignedTableBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3>Assign to Engineer</h3>
                        <div class="form-group">
                            <label for="adminEngineerSelect">Select Engineer*</label>
                            <select id="adminEngineerSelect">
                                <option value="">Select Engineer</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adminExpectedDate">Expected Completion Date</label>
                            <input type="date" id="adminExpectedDate">
                        </div>
                        <div class="form-group">
                            <label for="adminAssignNotes">Notes</label>
                            <textarea id="adminAssignNotes" rows="3"></textarea>
                        </div>
                        <button onclick="adminAssignCalls()">Assign Selected Calls</button>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="adminReports" class="tab-content">
                <h2>Reports</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label for="reportType">Report Type*</label>
                            <select id="reportType">
                                <option value="daily">Daily Call Report</option>
                                <option value="weekly">Weekly Summary</option>
                                <option value="monthly">Monthly Summary</option>
                                <option value="engineer">Engineer Performance</option>
                                <option value="amc">AMC vs Chargeable</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportStartDate">Start Date</label>
                            <input type="date" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label for="reportEndDate">End Date</label>
                            <input type="date" id="reportEndDate">
                        </div>
                        <div class="form-group">
                            <label for="reportEngineerFilter">Filter by Engineer</label>
                            <select id="reportEngineerFilter">
                                <option value="">All Engineers</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <button onclick="generateAdminReport()">Generate Report</button>
                    </div>
                    <div>
                        <h3>Report Preview</h3>
                        <div id="adminReportPreview" style="background-color: white; padding: 20px; min-height: 300px; border: 1px dashed #ccc;">
                            <p>Report will be displayed here</p>
                        </div>
                        <button style="margin-top: 10px;" onclick="exportAdminToExcel()">Export to Excel</button>
                    </div>
                </div>
            </div>

            <!-- Database Tab -->
            <div id="adminDatabase" class="tab-content">
                <h2>Database Management</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="exportDatabase()">Export Database</button>
                    <button onclick="document.getElementById('dbImportFile').click()" style="margin-left: 10px;">Import Database</button>
                    <input type="file" id="dbImportFile" style="display: none;" accept=".db,.sqlite">
                </div>
                <div style="margin-bottom: 20px;">
                    <button onclick="resetDatabase()" style="background-color: #e74c3c;">Reset Database</button>
                    <p style="color: #777; font-size: 14px;">Warning: This will delete all data and recreate the database structure.</p>
                </div>
                <div>
                    <h3>Database Status</h3>
                    <div id="dbStatus" style="background-color: #f9f9f9; padding: 15px; border-radius: 5px;">
                        <p>Database loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let db;
        const ADMIN_PASSWORD = "654123";
        let dbInitialized = false;
        let lastTicketId = null;

        // Initialize SQL.js when page loads
        async function initializeDatabase() {
            try {
                showNotification("Initializing service system...", "success");
                document.getElementById('submitBtn').innerHTML = '<span class="loading"></span> System initializing...';
                document.getElementById('submitBtn').disabled = true;
                
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${file}`
                });
                
                db = new SQL.Database();
                createDatabaseStructure();
                dbInitialized = true;
                updateDbStatus();
                
                document.getElementById('submitBtn').innerHTML = 'Submit Service Request';
                document.getElementById('submitBtn').disabled = false;
                showNotification("Service system ready to accept requests", "success");
            } catch (error) {
                console.error("Error initializing database:", error);
                document.getElementById('submitBtn').innerHTML = 'System Error - Refresh Page';
                showNotification("Error initializing service system. Please refresh the page.", "error");
            }
        }

        // Create database structure
        function createDatabaseStructure() {
            try {
                // Create Customers table
                db.exec(`
                    CREATE TABLE IF NOT EXISTS Customers (
                        customer_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        company TEXT,
                        contact_number TEXT NOT NULL,
                        email TEXT NOT NULL,
                        address TEXT NOT NULL
                    )
                `);
                
                // Create Engineers table
                db.exec(`
                    CREATE TABLE IF NOT EXISTS Engineers (
                        engineer_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        contact_number TEXT,
                        email TEXT,
                        specialization TEXT
                    )
                `);
                
                // Create ServiceCalls table
                db.exec(`
                    CREATE TABLE IF NOT EXISTS ServiceCalls (
                        call_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        customer_id INTEGER NOT NULL,
                        device_type TEXT NOT NULL,
                        brand_model TEXT,
                        serial_number TEXT,
                        issue_description TEXT NOT NULL,
                        service_type TEXT NOT NULL,
                        priority TEXT NOT NULL,
                        status TEXT DEFAULT 'Pending',
                        created_date TEXT DEFAULT CURRENT_TIMESTAMP,
                        completion_date TEXT,
                        FOREIGN KEY (customer_id) REFERENCES Customers(customer_id)
                    )
                `);
                
                // Create Assignments table
                db.exec(`
                    CREATE TABLE IF NOT EXISTS Assignments (
                        assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        call_id INTEGER NOT NULL,
                        engineer_id INTEGER NOT NULL,
                        assigned_date TEXT DEFAULT CURRENT_TIMESTAMP,
                        expected_date TEXT,
                        actual_date TEXT,
                        notes TEXT,
                        FOREIGN KEY (call_id) REFERENCES ServiceCalls(call_id),
                        FOREIGN KEY (engineer_id) REFERENCES Engineers(engineer_id)
                    )
                `);
                
                // Check if we need sample data
                const hasData = db.exec("SELECT COUNT(*) FROM Customers");
                if (hasData.length === 0 || hasData[0].values[0][0] === 0) {
                    addSampleData();
                }
            } catch (error) {
                console.error("Error creating database structure:", error);
                showNotification("Error creating database structure: " + error.message, "error");
            }
        }

        // Add sample data
        function addSampleData() {
            try {
                // Add sample customers
                db.exec(`
                    INSERT INTO Customers (name, company, contact_number, email, address)
                    VALUES 
                        ('John Smith', 'ABC Corp', '555-123-4567', 'john@example.com', '123 Main St, City'),
                        ('Sarah Johnson', 'XYZ Ltd', '555-987-6543', 'sarah@example.com', '456 Oak Ave, Town'),
                        ('Mike Brown', NULL, '555-555-1212', 'mike@example.com', '789 Pine Rd, Village')
                `);
                
                // Add sample engineers
                db.exec(`
                    INSERT INTO Engineers (name, contact_number, email, specialization)
                    VALUES 
                        ('Raj Sharma', '555-111-2222', 'raj@example.com', 'Laptop,Desktop'),
                        ('Priya Patel', '555-333-4444', 'priya@example.com', 'Printer,Network'),
                        ('Amit Kumar', '555-666-7777', 'amit@example.com', 'Server,Desktop')
                `);
                
                // Add sample service calls
                db.exec(`
                    INSERT INTO ServiceCalls (customer_id, device_type, brand_model, serial_number, issue_description, service_type, priority, status)
                    VALUES 
                        (1, 'Laptop', 'Dell XPS 15', 'DXPS12345', 'Not turning on', 'AMC', 'High', 'In Process'),
                        (2, 'Printer', 'HP LaserJet', 'HPLJ67890', 'Paper jam', 'Chargeable', 'Medium', 'Closed'),
                        (3, 'Server', 'Dell PowerEdge', 'DPWR54321', 'Network issues', 'AMC', 'Critical', 'Pending')
                `);
                
                // Add sample assignments
                db.exec(`
                    INSERT INTO Assignments (call_id, engineer_id, expected_date, notes)
                    VALUES 
                        (1, 1, '2023-06-15', 'Check power supply and motherboard'),
                        (2, 2, '2023-06-10', 'Cleared paper jam and tested')
                `);
            } catch (error) {
                console.error("Error adding sample data:", error);
            }
        }

        // Show notification
        function showNotification(message, type = "success") {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = "notification " + (type === "error" ? "error" : "");
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 3000);
        }

        // Form submission for new service call
        document.getElementById('serviceRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!dbInitialized) {
                showNotification("Service system is still initializing. Please try again in a moment.", "error");
                return;
            }
            
            try {
                // Insert customer first
                const customerName = document.getElementById('customerName').value;
                const companyName = document.getElementById('companyName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const email = document.getElementById('email').value;
                const address = document.getElementById('address').value;
                
                const customerStmt = db.prepare(`
                    INSERT INTO Customers (name, company, contact_number, email, address)
                    VALUES (?, ?, ?, ?, ?)
                `);
                customerStmt.bind([customerName, companyName, contactNumber, email, address]);
                customerStmt.step();
                const customerId = db.exec("SELECT last_insert_rowid()")[0].values[0][0];
                customerStmt.free();
                
                // Insert service call
                const deviceType = document.getElementById('deviceType').value;
                const brand = document.getElementById('brand').value;
                const serialNumber = document.getElementById('serialNumber').value;
                const issueDescription = document.getElementById('issueDescription').value;
                const serviceType = document.getElementById('serviceType').value;
                const priority = document.getElementById('priority').value;
                
                const callStmt = db.prepare(`
                    INSERT INTO ServiceCalls (customer_id, device_type, brand_model, serial_number, issue_description, service_type, priority)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                `);
                callStmt.bind([customerId, deviceType, brand, serialNumber, issueDescription, serviceType, priority]);
                callStmt.step();
                lastTicketId = db.exec("SELECT last_insert_rowid()")[0].values[0][0];
                callStmt.free();
                
                // Reset form
                this.reset();
                
                // Show ticket confirmation
                showTicketConfirmation(lastTicketId);
                
                showNotification("Service request submitted successfully!", "success");
                
                // Refresh admin panel if open
                if (document.getElementById('adminPanel').style.display === 'block') {
                    loadAdminCalls();
                    loadUnassignedCalls();
                }
            } catch (error) {
                console.error("Error submitting service request:", error);
                showNotification("Error submitting service request: " + error.message, "error");
            }
        });

        // Show ticket confirmation
        function showTicketConfirmation(ticketId) {
            const ticketNumber = `SR-${ticketId}`;
            const modalContent = `
                <h2>Service Request Submitted</h2>
                <div class="ticket-details">
                    <p>Your service request has been successfully submitted.</p>
                    <p class="ticket-id">Ticket Number: ${ticketNumber}</p>
                    <p>Please save this number for future reference.</p>
                    <p>You can check your service status anytime using this ticket number.</p>
                </div>
            `;
            document.getElementById('ticketDetails').innerHTML = modalContent;
            document.getElementById('ticketModal').style.display = 'flex';
        }

        // Close ticket modal
        function closeTicketModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }

        // Check ticket status
        function checkTicketStatus() {
            const ticketNumber = document.getElementById('ticketNumber').value;
            if (!ticketNumber || !ticketNumber.startsWith('SR-')) {
                showNotification("Please enter a valid ticket number (SR-XXXX)", "error");
                return;
            }
            
            const ticketId = parseInt(ticketNumber.split('-')[1]);
            if (isNaN(ticketId)) {
                showNotification("Invalid ticket number format", "error");
                return;
            }
            
            try {
                const stmt = db.prepare(`
                    SELECT 
                        'SR-' || sc.call_id AS ticket_id,
                        strftime('%Y-%m-%d', sc.created_date) AS call_date,
                        c.name AS customer_name,
                        sc.device_type,
                        sc.brand_model,
                        sc.issue_description,
                        sc.service_type,
                        sc.priority,
                        sc.status,
                        e.name AS engineer_name,
                        a.expected_date,
                        a.notes
                    FROM ServiceCalls sc
                    JOIN Customers c ON sc.customer_id = c.customer_id
                    LEFT JOIN Assignments a ON sc.call_id = a.call_id
                    LEFT JOIN Engineers e ON a.engineer_id = e.engineer_id
                    WHERE sc.call_id = ?
                `);
                stmt.bind([ticketId]);
                
                if (stmt.step()) {
                    const row = stmt.get();
                    
                    const modalContent = `
                        <h2>Service Request Status</h2>
                        <div class="ticket-details">
                            <p class="ticket-id">Ticket Number: ${row[0]}</p>
                            <p><strong>Date:</strong> ${row[1]}</p>
                            <p><strong>Customer:</strong> ${row[2]}</p>
                            <p><strong>Device:</strong> ${row[3]} ${row[4] ? '(' + row[4] + ')' : ''}</p>
                            <p><strong>Issue:</strong> ${row[5]}</p>
                            <p><strong>Service Type:</strong> ${row[6]}</p>
                            <p><strong>Priority:</strong> ${row[7]}</p>
                            <p><strong>Status:</strong> <span class="status-${row[8].toLowerCase().replace(' ', '')}">${row[8]}</span></p>
                            ${row[9] ? `<p><strong>Assigned Engineer:</strong> ${row[9]}</p>` : ''}
                            ${row[10] ? `<p><strong>Expected Completion:</strong> ${row[10]}</p>` : ''}
                            ${row[11] ? `<p><strong>Notes:</strong> ${row[11]}</p>` : ''}
                        </div>
                    `;
                    document.getElementById('ticketDetails').innerHTML = modalContent;
                    document.getElementById('ticketModal').style.display = 'flex';
                } else {
                    showNotification("Ticket not found", "error");
                }
                
                stmt.free();
            } catch (error) {
                console.error("Error checking ticket status:", error);
                showNotification("Error checking ticket status", "error");
            }
        }

        // Show admin login modal
        function showAdminLogin() {
            document.getElementById('passwordModal').style.display = "flex";
        }

        // Check admin password
        function checkAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('passwordModal').style.display = "none";
                document.getElementById('adminPanel').style.display = "block";
                loadAdminData();
                showNotification("Admin panel accessed successfully", "success");
            } else {
                alert("Incorrect password. Please try again.");
                document.getElementById('adminPasswordInput').value = "";
            }
        }

        // Load data for admin panel
        function loadAdminData() {
            loadAdminCalls();
            loadEngineers();
            loadUnassignedCalls();
            updateDbStatus();
        }

        // Load calls for admin panel
        function loadAdminCalls() {
            try {
                const stmt = db.prepare(`
                    SELECT 
                        sc.call_id,
                        'SR-' || sc.call_id AS ticket_id,
                        strftime('%Y-%m-%d', sc.created_date) AS call_date,
                        c.name AS customer_name,
                        sc.device_type,
                        sc.brand_model,
                        sc.issue_description,
                        sc.status
                    FROM ServiceCalls sc
                    JOIN Customers c ON sc.customer_id = c.customer_id
                    ORDER BY sc.created_date DESC
                `);
                
                const tableBody = document.getElementById('adminCallTableBody');
                tableBody.innerHTML = '';
                
                while (stmt.step()) {
                    const row = stmt.get();
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td>${row[4]} ${row[5] ? '(' + row[5] + ')' : ''}</td>
                        <td>${row[6]}</td>
                        <td class="status-${row[7].toLowerCase().replace(' ', '')}">${row[7]}</td>
                        <td>
                            <button onclick="adminViewDetails(${row[0]})">View</button>
                            <button onclick="adminUpdateStatus(${row[0]})">Update Status</button>
                            <button onclick="adminDeleteCall(${row[0]})" style="background-color: #e74c3c;">Delete</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(tr);
                }
                
                stmt.free();
            } catch (error) {
                console.error("Error loading admin calls:", error);
                showNotification("Error loading calls: " + error.message, "error");
            }
        }

        // Load engineers for admin panel
        function loadEngineers() {
            try {
                const stmt = db.prepare("SELECT engineer_id, name, contact_number, email, specialization FROM Engineers ORDER BY name");
                const tableBody = document.getElementById('engineerTableBody');
                const engineerSelect = document.getElementById('adminEngineerSelect');
                const reportEngineerFilter = document.getElementById('reportEngineerFilter');
                
                // Clear existing options except the first one
                tableBody.innerHTML = '';
                while (engineerSelect.options.length > 1) engineerSelect.remove(1);
                while (reportEngineerFilter.options.length > 1) reportEngineerFilter.remove(1);
                
                while (stmt.step()) {
                    const row = stmt.get();
                    
                    // Add to engineers table
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td>${row[4]}</td>
                        <td>
                            <button onclick="adminEditEngineer(${row[0]})">Edit</button>
                            <button onclick="adminDeleteEngineer(${row[0]})" style="background-color: #e74c3c;">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                    
                    // Add to dropdowns
                    const option1 = document.createElement('option');
                    option1.value = row[0];
                    option1.textContent = row[1];
                    engineerSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = row[0];
                    option2.textContent = row[1];
                    reportEngineerFilter.appendChild(option2);
                }
                
                stmt.free();
            } catch (error) {
                console.error("Error loading engineers:", error);
                showNotification("Error loading engineers: " + error.message, "error");
            }
        }

        // Load unassigned calls for admin panel
        function loadUnassignedCalls() {
            try {
                const stmt = db.prepare(`
                    SELECT 
                        sc.call_id,
                        'SR-' || sc.call_id AS ticket_id,
                        c.name AS customer_name,
                        sc.device_type,
                        sc.brand_model,
                        sc.issue_description
                    FROM ServiceCalls sc
                    JOIN Customers c ON sc.customer_id = c.customer_id
                    LEFT JOIN Assignments a ON sc.call_id = a.call_id
                    WHERE a.assignment_id IS NULL AND sc.status != 'Closed'
                    ORDER BY sc.created_date DESC
                `);
                
                const tableBody = document.getElementById('adminUnassignedTableBody');
                tableBody.innerHTML = '';
                
                while (stmt.step()) {
                    const row = stmt.get();
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td><input type="checkbox" value="${row[0]}"></td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]} ${row[4] ? '(' + row[4] + ')' : ''}</td>
                        <td>${row[5]}</td>
                    `;
                    
                    tableBody.appendChild(tr);
                }
                
                stmt.free();
            } catch (error) {
                console.error("Error loading unassigned calls:", error);
                showNotification("Error loading unassigned calls: " + error.message, "error");
            }
        }

        // Admin tab switching
        function openAdminTab(tabName) {
            const tabs = document.querySelectorAll('#adminPanel .tab');
            const tabContents = document.querySelectorAll('#adminPanel .tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Admin view details
        function adminViewDetails(callId) {
            try {
                const stmt = db.prepare(`
                    SELECT 
                        'SR-' || sc.call_id AS ticket_id,
                        strftime('%Y-%m-%d', sc.created_date) AS call_date,
                        c.name AS customer_name,
                        c.company,
                        c.contact_number,
                        c.email,
                        c.address,
                        sc.device_type,
                        sc.brand_model,
                        sc.serial_number,
                        sc.issue_description,
                        sc.service_type,
                        sc.priority,
                        sc.status,
                        e.name AS engineer_name,
                        a.expected_date,
                        a.notes
                    FROM ServiceCalls sc
                    JOIN Customers c ON sc.customer_id = c.customer_id
                    LEFT JOIN Assignments a ON sc.call_id = a.call_id
                    LEFT JOIN Engineers e ON a.engineer_id = e.engineer_id
                    WHERE sc.call_id = ?
                `);
                stmt.bind([callId]);
                
                if (stmt.step()) {
                    const row = stmt.get();
                    
                    const modalContent = `
                        <h2>Service Request Details</h2>
                        <div class="ticket-details">
                            <p class="ticket-id">Ticket Number: ${row[0]}</p>
                            <p><strong>Date:</strong> ${row[1]}</p>
                            <p><strong>Customer:</strong> ${row[2]}</p>
                            ${row[3] ? `<p><strong>Company:</strong> ${row[3]}</p>` : ''}
                            <p><strong>Contact:</strong> ${row[4]}</p>
                            <p><strong>Email:</strong> ${row[5]}</p>
                            <p><strong>Address:</strong> ${row[6]}</p>
                            <p><strong>Device:</strong> ${row[7]} ${row[8] ? '(' + row[8] + ')' : ''}</p>
                            ${row[9] ? `<p><strong>Serial Number:</strong> ${row[9]}</p>` : ''}
                            <p><strong>Issue:</strong> ${row[10]}</p>
                            <p><strong>Service Type:</strong> ${row[11]}</p>
                            <p><strong>Priority:</strong> ${row[12]}</p>
                            <p><strong>Status:</strong> <span class="status-${row[13].toLowerCase().replace(' ', '')}">${row[13]}</span></p>
                            ${row[14] ? `<p><strong>Assigned Engineer:</strong> ${row[14]}</p>` : ''}
                            ${row[15] ? `<p><strong>Expected Completion:</strong> ${row[15]}</p>` : ''}
                            ${row[16] ? `<p><strong>Notes:</strong> ${row[16]}</p>` : ''}
                        </div>
                    `;
                    document.getElementById('ticketDetails').innerHTML = modalContent;
                    document.getElementById('ticketModal').style.display = 'flex';
                }
                
                stmt.free();
            } catch (error) {
                console.error("Error viewing details:", error);
                showNotification("Error viewing details: " + error.message, "error");
            }
        }

        // Admin update status
        function adminUpdateStatus(callId) {
            const newStatus = prompt("Enter new status (Pending, In Process, Closed):");
            if (newStatus && ['Pending', 'In Process', 'Closed'].includes(newStatus)) {
                try {
                    const stmt = db.prepare("UPDATE ServiceCalls SET status = ? WHERE call_id = ?");
                    stmt.bind([newStatus, callId]);
                    stmt.step();
                    stmt.free();
                    
                    if (newStatus === 'Closed') {
                        const dateStmt = db.prepare("UPDATE ServiceCalls SET completion_date = date('now') WHERE call_id = ?");
                        dateStmt.bind([callId]);
                        dateStmt.step();
                        dateStmt.free();
                    }
                    
                    showNotification("Status updated successfully", "success");
                    loadAdminCalls();
                    loadUnassignedCalls();
                } catch (error) {
                    console.error("Error updating status:", error);
                    showNotification("Error updating status: " + error.message, "error");
                }
            }
        }

        // Admin delete call
        function adminDeleteCall(callId) {
            if (confirm("Are you sure you want to delete this service call? This action cannot be undone.")) {
                try {
                    // First delete any assignments
                    const assignStmt = db.prepare("DELETE FROM Assignments WHERE call_id = ?");
                    assignStmt.bind([callId]);
                    assignStmt.step();
                    assignStmt.free();
                    
                    // Then delete the call
                    const callStmt = db.prepare("DELETE FROM ServiceCalls WHERE call_id = ?");
                    callStmt.bind([callId]);
                    callStmt.step();
                    callStmt.free();
                    
                    showNotification("Service call deleted successfully", "success");
                    loadAdminCalls();
                    loadUnassignedCalls();
                } catch (error) {
                    console.error("Error deleting service call:", error);
                    showNotification("Error deleting service call: " + error.message, "error");
                }
            }
        }

        // Admin assign calls
        function adminAssignCalls() {
            const engineerId = document.getElementById('adminEngineerSelect').value;
            if (!engineerId) {
                showNotification("Please select an engineer", "error");
                return;
            }
            
            const expectedDate = document.getElementById('adminExpectedDate').value;
            const notes = document.getElementById('adminAssignNotes').value;
            
            try {
                const checkboxes = document.querySelectorAll('#adminUnassignedTableBody input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    showNotification("Please select at least one call to assign", "error");
                    return;
                }
                
                checkboxes.forEach(checkbox => {
                    const callId = checkbox.value;
                    const stmt = db.prepare(`
                        INSERT INTO Assignments (call_id, engineer_id, expected_date, notes)
                        VALUES (?, ?, ?, ?)
                    `);
                    stmt.bind([callId, engineerId, expectedDate, notes]);
                    stmt.step();
                    stmt.free();
                    
                    // Update call status to "In Process"
                    const updateStmt = db.prepare(`
                        UPDATE ServiceCalls SET status = 'In Process' WHERE call_id = ?
                    `);
                    updateStmt.bind([callId]);
                    updateStmt.step();
                    updateStmt.free();
                });
                
                // Clear form
                document.getElementById('adminExpectedDate').value = '';
                document.getElementById('adminAssignNotes').value = '';
                
                showNotification(`${checkboxes.length} call(s) assigned successfully`, "success");
                loadAdminCalls();
                loadUnassignedCalls();
            } catch (error) {
                console.error("Error assigning calls:", error);
                showNotification("Error assigning calls: " + error.message, "error");
            }
        }

        // Add new engineer
        document.getElementById('engineerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('engineerName').value;
            const contact = document.getElementById('engineerContact').value;
            const email = document.getElementById('engineerEmail').value;
            const specialization = document.getElementById('engineerSpecialization').value;
            
            try {
                const stmt = db.prepare(`
                    INSERT INTO Engineers (name, contact_number, email, specialization)
                    VALUES (?, ?, ?, ?)
                `);
                stmt.bind([name, contact, email, specialization]);
                stmt.step();
                stmt.free();
                
                // Reset form
                this.reset();
                
                showNotification("Engineer added successfully", "success");
                loadEngineers();
            } catch (error) {
                console.error("Error adding engineer:", error);
                showNotification("Error adding engineer: " + error.message, "error");
            }
        });

        // Edit engineer
        function adminEditEngineer(engineerId) {
            const newName = prompt("Enter new name:", document.querySelector(`#engineerTableBody tr[data-id="${engineerId}"] td:first-child`).textContent);
            if (newName) {
                try {
                    const stmt = db.prepare("UPDATE Engineers SET name = ? WHERE engineer_id = ?");
                    stmt.bind([newName, engineerId]);
                    stmt.step();
                    stmt.free();
                    
                    showNotification("Engineer updated successfully", "success");
                    loadEngineers();
                } catch (error) {
                    console.error("Error updating engineer:", error);
                    showNotification("Error updating engineer: " + error.message, "error");
                }
            }
        }

        // Delete engineer
        function adminDeleteEngineer(engineerId) {
            if (confirm("Are you sure you want to delete this engineer?")) {
                try {
                    // First check if engineer has any assignments
                    const checkStmt = db.prepare("SELECT COUNT(*) FROM Assignments WHERE engineer_id = ?");
                    checkStmt.bind([engineerId]);
                    checkStmt.step();
                    const assignmentCount = checkStmt.get()[0];
                    checkStmt.free();
                    
                    if (assignmentCount > 0) {
                        showNotification("Cannot delete engineer with assigned calls", "error");
                        return;
                    }
                    
                    const stmt = db.prepare("DELETE FROM Engineers WHERE engineer_id = ?");
                    stmt.bind([engineerId]);
                    stmt.step();
                    stmt.free();
                    
                    showNotification("Engineer deleted successfully", "success");
                    loadEngineers();
                } catch (error) {
                    console.error("Error deleting engineer:", error);
                    showNotification("Error deleting engineer: " + error.message, "error");
                }
            }
        }

        // Generate admin report
        function generateAdminReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const engineerId = document.getElementById('reportEngineerFilter').value;
            
            let reportContent = `<h3>${reportType.replace(/\b\w/g, l => l.toUpperCase())} Report</h3>`;
            
            if (startDate || endDate) {
                reportContent += `<p>Date range: ${startDate || 'Start'} to ${endDate || 'End'}</p>`;
            }
            
            if (engineerId) {
                const engineerName = document.getElementById('reportEngineerFilter').options[document.getElementById('reportEngineerFilter').selectedIndex].text;
                reportContent += `<p>Engineer: ${engineerName}</p>`;
            }
            
            // In a real app, this would query the database and generate proper reports
            reportContent += `<p>Sample report data would be displayed here based on the selected criteria.</p>`;
            reportContent += `<p>This would include statistics, charts, and detailed call information.</p>`;
            
            document.getElementById('adminReportPreview').innerHTML = reportContent;
            showNotification("Report generated", "success");
        }

        // Export admin report to Excel
        function exportAdminToExcel() {
            alert("This would export the report to Excel in a real implementation");
        }

        // Export database
        function exportDatabase() {
            if (!dbInitialized) {
                showNotification("Database not initialized", "error");
                return;
            }
            
            try {
                const data = db.export();
                const blob = new Blob([data], {type: 'application/octet-stream'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'service_calls_export.db';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification("Database exported successfully", "success");
            } catch (error) {
                console.error("Error exporting database:", error);
                showNotification("Error exporting database: " + error.message, "error");
            }
        }

        // Handle database import file selection
        document.getElementById('dbImportFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function() {
                try {
                    const uint8Array = new Uint8Array(reader.result);
                    db = new SQL.Database(uint8Array);
                    dbInitialized = true;
                    updateDbStatus();
                    loadAdminData();
                    showNotification("Database imported successfully", "success");
                } catch (error) {
                    console.error("Error importing database:", error);
                    showNotification("Error importing database: " + error.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Reset database
        function resetDatabase() {
            if (confirm("Are you sure you want to reset the database? All data will be lost!")) {
                try {
                    db.close();
                    db = new SQL.Database();
                    createDatabaseStructure();
                    dbInitialized = true;
                    updateDbStatus();
                    loadAdminData();
                    showNotification("Database reset successfully", "success");
                } catch (error) {
                    console.error("Error resetting database:", error);
                    showNotification("Error resetting database: " + error.message, "error");
                }
            }
        }

        // Update database status
        function updateDbStatus() {
            if (!dbInitialized) {
                document.getElementById('dbStatus').innerHTML = `<p>Database not initialized</p>`;
                return;
            }
            
            try {
                const customers = db.exec("SELECT COUNT(*) FROM Customers")[0].values[0][0];
                const engineers = db.exec("SELECT COUNT(*) FROM Engineers")[0].values[0][0];
                const calls = db.exec("SELECT COUNT(*) FROM ServiceCalls")[0].values[0][0];
                const assignments = db.exec("SELECT COUNT(*) FROM Assignments")[0].values[0][0];
                
                document.getElementById('dbStatus').innerHTML = `
                    <p><strong>Customers:</strong> ${customers}</p>
                    <p><strong>Engineers:</strong> ${engineers}</p>
                    <p><strong>Service Calls:</strong> ${calls}</p>
                    <p><strong>Assignments:</strong> ${assignments}</p>
                    <p><strong>Status:</strong> Operational</p>
                `;
            } catch (error) {
                console.error("Error checking database status:", error);
                document.getElementById('dbStatus').innerHTML = `<p>Error checking database status</p>`;
            }
        }

        // Filter admin calls
        function filterAdminCalls() {
            const statusFilter = document.getElementById('callStatusFilter').value;
            const rows = document.querySelectorAll('#adminCallTableBody tr');
            
            rows.forEach(row => {
                const status = row.querySelector('td:nth-child(6)').textContent;
                
                if (statusFilter === 'All' || status === statusFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Initialize the database when page loads
        initializeDatabase();
    </script>
</body>
</html>