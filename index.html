<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Digital Diary - Spread your Knowledge with Your Friends/Groups</title>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button.delete { background: #f44336; }
        button.export { background: #ff9800; }
        button.import { background: #9c27b0; }
        button.category { background: #607d8b; }
        button.pdf { background: #e91e63; }
        .topic-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topic-item:hover { background: #eee; }
        .topic-category {
            font-size: 0.8em;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .category-filter {
            margin-bottom: 15px;
        }
        .category-tag {
            display: inline-block;
            padding: 3px 8px;
            background: #e0e0e0;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            margin-right: 5px;
        }
        .category-tag:hover { background: #bdbdbd; }
        .category-tag.active {
            background: #4CAF50;
            color: white;
        }
        .search-results { margin-top: 20px; }
        #editor-container {
            height: 300px;
            margin-bottom: 15px;
        }
        .topic-actions { display: flex; gap: 5px; }
        .action-btn {
            padding: 2px 6px;
            font-size: 0.8em;
        }
        .topic-select { margin-right: 10px; }
        .view-topic { cursor: pointer; flex-grow: 1; }
        #allTopicsTag { font-weight: bold; }
        
        /* Topic viewer styles */
        .topic-viewer {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            display: none;
        }
        .edit-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .view-mode .ql-toolbar {
            display: none;
        }
        .view-mode .ql-container {
            border: none;
        }
        .view-mode .ql-editor {
            padding: 0;
        }
        #topicContent {
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        /* Category management styles */
        .category-management {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .category-actions {
            display: flex;
            gap: 5px;
        }
        .category-edit-btn {
            background: #2196F3;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        .category-delete-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: black;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>My Digital Diary - Spread your Knowledge with Your Friends/Groups</h1>
    
    <div class="container">
        <div class="panel">
            <h2>Create/Edit Topic</h2>
            <input type="text" id="topicTitle" placeholder="Title">
            <select id="topicCategory">
                <option value="">-- Select Category --</option>
            </select>
            <input type="text" id="newCategory" placeholder="New category name">
            <button id="addCategoryBtn" class="category">Add Category</button>
            
            <div id="editor-container"></div>
            
            <div class="topic-viewer" id="topicViewer">
                <div class="edit-bar">
                    <h3 id="viewerTitle"></h3>
                    <div>
                        <button id="editTopicBtn">Edit</button>
                        <button id="closeViewerBtn">Close</button>
                    </div>
                </div>
                <div id="topicContent"></div>
            </div>
            
            <div class="button-group">
                <button id="saveBtn">Save</button>
                <button id="newBtn">New</button>
                <button id="deleteBtn" class="delete">Delete</button>
            </div>
            
            <div class="category-management">
                <h3>Category Management</h3>
                <div id="categoryList"></div>
            </div>
            
            <h2>Import/Export</h2>
            <button id="exportAllBtn" class="export">Export All</button>
            <button id="exportSelectedBtn" class="export">Export Selected</button>
            <button id="importBtn" class="import">Import</button>
            <input type="file" id="fileInput" style="display:none">
            
            <h2>Search</h2>
            <input type="text" id="searchInput" placeholder="Search...">
            <button id="searchBtn">Search</button>
        </div>
        
        <div class="panel">
            <h2>Topics</h2>
            <div class="category-filter">
                <span class="category-tag active" id="allTopicsTag" data-category="">All Topics</span>
            </div>
            <div id="topicList"></div>
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Edit Category</h3>
            <input type="text" id="editCategoryName" placeholder="Category name">
            <div class="modal-footer">
                <button id="saveEditCategoryBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Category Modal -->
    <div id="deleteCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Delete Category</h3>
            <div id="deleteCategoryMessage"></div>
            <div id="reassignCategorySection" style="display: none; margin-top: 15px;">
                <p>Please select a new category for affected topics:</p>
                <select id="reassignCategorySelect" style="width: 100%; margin-bottom: 15px;"></select>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteCategoryBtn" class="delete">Confirm Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Quill editor
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['clean'],
                    ['link', 'image', 'video']
                ]
            },
            placeholder: 'Write your content here...'
        });

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Database using localStorage
        const db = {
            getData: () => {
                const data = JSON.parse(localStorage.getItem('topicData')) || { topics: [], categories: [] };
                // Ensure all topics have required fields
                data.topics = data.topics.map(topic => ({
                    id: topic.id || Date.now().toString(),
                    title: topic.title || 'Untitled',
                    content: topic.content || '',
                    category: topic.category || '',
                    updatedAt: topic.updatedAt || new Date().toISOString(),
                    createdAt: topic.createdAt || new Date().toISOString()
                }));
                return data;
            },
            saveData: (data) => localStorage.setItem('topicData', JSON.stringify(data)),
            
            addTopic: (topic) => {
                const data = db.getData();
                data.topics.push(topic);
                db.saveData(data);
            },
            
            updateTopic: (id, updates) => {
                const data = db.getData();
                const index = data.topics.findIndex(t => t.id === id);
                if (index !== -1) {
                    data.topics[index] = { ...data.topics[index], ...updates };
                    db.saveData(data);
                }
            },
            
            deleteTopic: (id) => {
                const data = db.getData();
                data.topics = data.topics.filter(t => t.id !== id);
                db.saveData(data);
            },
            
            addCategory: (name) => {
                if (!name) return;
                const data = db.getData();
                if (!data.categories.includes(name)) {
                    data.categories.push(name);
                    db.saveData(data);
                }
            },
            
            updateCategory: (oldName, newName) => {
                if (!oldName || !newName) return;
                const data = db.getData();
                
                // Update category name in categories array
                const catIndex = data.categories.indexOf(oldName);
                if (catIndex !== -1) {
                    data.categories[catIndex] = newName;
                }
                
                // Update category in all topics
                data.topics = data.topics.map(topic => {
                    if (topic.category === oldName) {
                        return { ...topic, category: newName };
                    }
                    return topic;
                });
                
                db.saveData(data);
            },
            
            deleteCategory: (name, reassignTo = '') => {
                if (!name) return;
                const data = db.getData();
                
                // Remove category from categories array
                data.categories = data.categories.filter(c => c !== name);
                
                // Update topics that had this category
                data.topics = data.topics.map(topic => {
                    if (topic.category === name) {
                        return { ...topic, category: reassignTo };
                    }
                    return topic;
                });
                
                db.saveData(data);
            },
            
            getTopicsByCategory: (category) => {
                const data = db.getData();
                return data.topics.filter(t => t.category === category);
            }
        };

        // DOM Elements
        const el = {
            title: document.getElementById('topicTitle'),
            category: document.getElementById('topicCategory'),
            newCategory: document.getElementById('newCategory'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            saveBtn: document.getElementById('saveBtn'),
            newBtn: document.getElementById('newBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            exportAllBtn: document.getElementById('exportAllBtn'),
            exportSelectedBtn: document.getElementById('exportSelectedBtn'),
            importBtn: document.getElementById('importBtn'),
            fileInput: document.getElementById('fileInput'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            topicList: document.getElementById('topicList'),
            searchResults: document.getElementById('searchResults'),
            categoryFilter: document.querySelector('.category-filter'),
            allTopicsTag: document.getElementById('allTopicsTag'),
            topicViewer: document.getElementById('topicViewer'),
            viewerTitle: document.getElementById('viewerTitle'),
            topicContent: document.getElementById('topicContent'),
            editTopicBtn: document.getElementById('editTopicBtn'),
            closeViewerBtn: document.getElementById('closeViewerBtn'),
            categoryList: document.getElementById('categoryList'),
            editCategoryModal: document.getElementById('editCategoryModal'),
            editCategoryName: document.getElementById('editCategoryName'),
            saveEditCategoryBtn: document.getElementById('saveEditCategoryBtn'),
            deleteCategoryModal: document.getElementById('deleteCategoryModal'),
            deleteCategoryMessage: document.getElementById('deleteCategoryMessage'),
            reassignCategorySection: document.getElementById('reassignCategorySection'),
            reassignCategorySelect: document.getElementById('reassignCategorySelect'),
            confirmDeleteCategoryBtn: document.getElementById('confirmDeleteCategoryBtn'),
            closeModalBtns: document.querySelectorAll('.close-modal')
        };

        let currentTopicId = null;
        let selectedCategory = '';
        let currentCategoryBeingEdited = null;
        let currentCategoryBeingDeleted = null;

        // Load categories into dropdown and display them
        function loadCategories() {
            const data = db.getData();
            el.category.innerHTML = '<option value="">-- Select Category --</option>';
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                el.category.appendChild(option);
            });
            
            // Update category filter (keep "All Topics" first)
            el.categoryFilter.innerHTML = '';
            const allSpan = document.createElement('span');
            allSpan.className = 'category-tag active';
            allSpan.id = 'allTopicsTag';
            allSpan.textContent = 'All Topics';
            allSpan.dataset.category = '';
            allSpan.addEventListener('click', () => filterByCategory(''));
            el.categoryFilter.appendChild(allSpan);
            
            data.categories.forEach(cat => {
                const span = document.createElement('span');
                span.className = 'category-tag';
                if (cat === selectedCategory) span.classList.add('active');
                span.textContent = cat;
                span.dataset.category = cat;
                span.addEventListener('click', () => filterByCategory(cat));
                el.categoryFilter.appendChild(span);
            });
            
            // Display categories in management section
            displayCategories();
        }

        // Display categories in the management section
        function displayCategories() {
            const data = db.getData();
            el.categoryList.innerHTML = '';
            
            if (data.categories.length === 0) {
                el.categoryList.innerHTML = '<p>No categories yet</p>';
                return;
            }
            
            data.categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = category;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'category-edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => openEditCategoryModal(category));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'category-delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => openDeleteCategoryModal(category));
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                div.appendChild(nameSpan);
                div.appendChild(actionsDiv);
                
                el.categoryList.appendChild(div);
            });
        }

        // Display topics with proper filtering
        function displayTopics() {
            const data = db.getData();
            let topics = data.topics;
            
            // Filter by category if one is selected (empty string shows all)
            if (selectedCategory !== '') {
                topics = topics.filter(t => t.category === selectedCategory);
            }
            
            // Sort by updatedAt (newest first)
            topics.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            el.topicList.innerHTML = '';
            
            if (topics.length === 0) {
                el.topicList.innerHTML = '<p>No topics found</p>';
                return;
            }
            
            topics.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'topic-item';
                div.dataset.id = topic.id;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'topic-select';
                checkbox.dataset.id = topic.id;
                
                const viewDiv = document.createElement('div');
                viewDiv.className = 'view-topic';
                viewDiv.innerHTML = `
                    <strong>${topic.title}</strong>
                    <div style="font-size:0.8em;color:#666;">
                        ${new Date(topic.updatedAt).toLocaleString()}
                    </div>
                `;
                viewDiv.addEventListener('click', () => viewTopic(topic.id));
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'topic-category';
                categorySpan.textContent = topic.category || 'Uncategorized';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'topic-actions';
                
                const pdfBtn = document.createElement('button');
                pdfBtn.className = 'action-btn pdf';
                pdfBtn.textContent = 'PDF';
                pdfBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exportToPDF(topic);
                });
                
                actionsDiv.appendChild(pdfBtn);
                
                div.appendChild(checkbox);
                div.appendChild(viewDiv);
                div.appendChild(categorySpan);
                div.appendChild(actionsDiv);
                
                el.topicList.appendChild(div);
            });
        }

        // Filter by category
        function filterByCategory(category) {
            selectedCategory = category;
            
            // Update active tags
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.toggle('active', tag.dataset.category === category);
            });
            
            displayTopics();
        }

        // View topic in read-only mode
        function viewTopic(id) {
            const topic = db.getData().topics.find(t => t.id === id);
            if (topic) {
                currentTopicId = id;
                el.viewerTitle.textContent = topic.title;
                el.topicContent.innerHTML = topic.content;
                
                // Highlight the topic in the list
                document.querySelectorAll('.topic-item').forEach(item => {
                    item.style.background = item.dataset.id === id ? '#e6f7ff' : '#f9f9f9';
                });
                
                // Show viewer and hide editor
                el.topicViewer.style.display = 'block';
                document.getElementById('editor-container').style.display = 'none';
                quill.enable(false);
                document.querySelector('#editor-container .ql-toolbar').style.display = 'none';
                document.querySelector('#editor-container .ql-container').style.border = 'none';
            }
        }

        // Edit existing topic
        function editTopic() {
            const topic = db.getData().topics.find(t => t.id === currentTopicId);
            if (topic) {
                el.title.value = topic.title;
                el.category.value = topic.category || '';
                quill.root.innerHTML = topic.content;
                
                // Switch to edit mode
                el.topicViewer.style.display = 'none';
                document.getElementById('editor-container').style.display = 'block';
                quill.enable(true);
                document.querySelector('#editor-container .ql-toolbar').style.display = '';
                document.querySelector('#editor-container .ql-container').style.border = '';
                el.title.focus();
            }
        }

        // Save topic
        function saveTopic() {
            const title = el.title.value.trim();
            if (!title) return alert('Title is required');
            
            const content = quill.root.innerHTML;
            const category = el.category.value || '';
            
            const topic = {
                id: currentTopicId || Date.now().toString(),
                title,
                content,
                category,
                updatedAt: new Date().toISOString(),
                createdAt: currentTopicId ? undefined : new Date().toISOString()
            };
            
            if (currentTopicId) {
                db.updateTopic(currentTopicId, topic);
            } else {
                db.addTopic(topic);
            }
            
            resetForm();
            loadCategories();
            displayTopics();
        }

        // Add new category
        function addCategory() {
            const name = el.newCategory.value.trim();
            if (!name) return;
            
            db.addCategory(name);
            el.newCategory.value = '';
            loadCategories();
        }

        // Delete topic
        function deleteTopic() {
            if (!currentTopicId) return alert('No topic selected');
            if (confirm('Delete this topic?')) {
                db.deleteTopic(currentTopicId);
                resetForm();
                displayTopics();
            }
        }

        // Reset form
        function resetForm() {
            currentTopicId = null;
            el.title.value = '';
            el.category.value = '';
            quill.root.innerHTML = '';
            el.title.focus();
            
            // Hide viewer and show editor
            el.topicViewer.style.display = 'none';
            document.getElementById('editor-container').style.display = 'block';
            quill.enable(true);
            document.querySelector('#editor-container .ql-toolbar').style.display = '';
            document.querySelector('#editor-container .ql-container').style.border = '';
            
            // Remove highlighting from topics list
            document.querySelectorAll('.topic-item').forEach(item => {
                item.style.background = '#f9f9f9';
            });
        }

        // Export to PDF
        function exportToPDF(topic) {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(33, 150, 243);
            doc.text(topic.title, 15, 20);
            
            // Add category if exists
            if (topic.category) {
                doc.setFontSize(12);
                doc.setTextColor(128, 128, 128);
                doc.text(`Category: ${topic.category}`, 15, 30);
            }
            
            // Add date
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Last updated: ${new Date(topic.updatedAt).toLocaleString()}`, 15, 40);
            
            // Add content (simple text version)
            const content = document.createElement('div');
            content.innerHTML = topic.content;
            const textContent = content.textContent || "";
            
            const lines = doc.splitTextToSize(textContent, 180);
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(lines, 15, 50);
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Exported from Topic Manager on ${new Date().toLocaleString()}`, 15, doc.internal.pageSize.height - 10);
            
            // Save the PDF
            doc.save(`${topic.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
        }

        // Export all topics
        function exportAllTopics() {
            const topics = db.getData().topics;
            if (topics.length === 0) return alert('No topics to export');
            
            const json = JSON.stringify(topics, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all-topics-export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export selected topics
        function exportSelectedTopics() {
            const selected = Array.from(document.querySelectorAll('.topic-select:checked'));
            if (selected.length === 0) return alert('No topics selected');
            
            const data = db.getData();
            const topicsToExport = selected.map(checkbox => {
                return data.topics.find(t => t.id === checkbox.dataset.id);
            }).filter(Boolean);
            
            const json = JSON.stringify(topicsToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected-topics-export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import topics
        function importTopics() {
            el.fileInput.click();
        }

        // Handle file import
        el.fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTopics = JSON.parse(e.target.result);
                    if (!Array.isArray(importedTopics)) throw new Error('Invalid format');
                    
                    importTopicSelection(importedTopics);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // Import topic selection
        function importTopicSelection(importedTopics) {
            const existingIds = db.getData().topics.map(t => t.id);
            const newTopics = importedTopics.filter(t => !existingIds.includes(t.id));
            
            if (newTopics.length === 0) {
                return alert('No new topics to import');
            }
            
            let html = '<h3>Select Topics to Import</h3>';
            html += '<div style="margin-bottom:10px;">';
            html += '<input type="checkbox" id="selectAll" checked> ';
            html += '<label for="selectAll">Select All</label>';
            html += '</div>';
            
            newTopics.forEach(topic => {
                html += `
                    <div style="margin-bottom:5px;">
                        <input type="checkbox" class="import-checkbox" id="imp-${topic.id}" checked>
                        <label for="imp-${topic.id}">
                            <strong>${topic.title || 'Untitled'}</strong>
                            ${topic.category ? `<span class="topic-category">${topic.category}</span>` : ''}
                            <div style="font-size:0.8em;color:#666;">
                                ${topic.updatedAt ? new Date(topic.updatedAt).toLocaleString() : ''}
                            </div>
                        </label>
                    </div>
                `;
            });
            
            html += '<button id="confirmImport">Import Selected</button>';
            el.searchResults.innerHTML = html;
            
            // Select all/none
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.import-checkbox').forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            document.getElementById('confirmImport').addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.import-checkbox:checked'));
                if (selected.length === 0) return alert('No topics selected');
                
                const data = db.getData();
                const topicsToImport = newTopics.filter(t => 
                    selected.some(s => s.id === `imp-${t.id}`)
                ).map(topic => ({
                    ...topic,
                    // Ensure all required fields exist
                    id: topic.id || Date.now().toString(),
                    title: topic.title || 'Untitled',
                    content: topic.content || '',
                    category: topic.category || '',
                    updatedAt: topic.updatedAt || new Date().toISOString(),
                    createdAt: topic.createdAt || new Date().toISOString()
                }));
                
                // Add any new categories
                topicsToImport.forEach(topic => {
                    if (topic.category && !data.categories.includes(topic.category)) {
                        data.categories.push(topic.category);
                    }
                });
                
                data.topics = [...data.topics, ...topicsToImport];
                db.saveData(data);
                
                el.searchResults.innerHTML = `<p>Successfully imported ${topicsToImport.length} topics</p>`;
                loadCategories();
                displayTopics();
                el.fileInput.value = '';
            });
        }

        // Search topics
        function searchTopics() {
            const query = el.searchInput.value.trim().toLowerCase();
            if (!query) {
                el.searchResults.innerHTML = '';
                return;
            }
            
            const results = db.getData().topics.filter(topic => 
                (topic.title && topic.title.toLowerCase().includes(query)) || 
                (topic.content && topic.content.toLowerCase().includes(query)) ||
                (topic.category && topic.category.toLowerCase().includes(query))
            );
            
            if (results.length === 0) {
                el.searchResults.innerHTML = '<p>No results found</p>';
                return;
            }
            
            let html = '<h3>Search Results</h3>';
            results.forEach(topic => {
                html += `
                    <div class="topic-item" data-id="${topic.id}">
                        <div class="view-topic">
                            <strong>${topic.title}</strong>
                            <span class="topic-category">${topic.category || 'Uncategorized'}</span>
                            <div style="font-size:0.8em;color:#666;">
                                ${new Date(topic.updatedAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            el.searchResults.innerHTML = html;
            
            // Make search results clickable
            document.querySelectorAll('#searchResults .topic-item').forEach(item => {
                item.addEventListener('click', () => viewTopic(item.dataset.id));
            });
        }

        // Open edit category modal
        function openEditCategoryModal(category) {
            currentCategoryBeingEdited = category;
            el.editCategoryName.value = category;
            el.editCategoryModal.style.display = 'block';
        }

        // Open delete category modal
        function openDeleteCategoryModal(category) {
            currentCategoryBeingDeleted = category;
            const topicsInCategory = db.getTopicsByCategory(category);
            
            if (topicsInCategory.length > 0) {
                el.deleteCategoryMessage.innerHTML = `
                    <p>This category has ${topicsInCategory.length} topic(s).</p>
                    <p>You need to reassign these topics before deleting the category.</p>
                `;
                el.reassignCategorySection.style.display = 'block';
                
                // Populate the reassign select
                const data = db.getData();
                el.reassignCategorySelect.innerHTML = '<option value="">-- Uncategorized --</option>';
                data.categories.filter(c => c !== category).forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    el.reassignCategorySelect.appendChild(option);
                });
            } else {
                el.deleteCategoryMessage.innerHTML = '<p>Are you sure you want to delete this category?</p>';
                el.reassignCategorySection.style.display = 'none';
            }
            
            el.deleteCategoryModal.style.display = 'block';
        }

        // Close all modals
        function closeModals() {
            el.editCategoryModal.style.display = 'none';
            el.deleteCategoryModal.style.display = 'none';
        }

        // Save category changes
        function saveCategoryChanges() {
            const newName = el.editCategoryName.value.trim();
            if (!newName) return alert('Category name cannot be empty');
            if (newName === currentCategoryBeingEdited) return closeModals();
            
            db.updateCategory(currentCategoryBeingEdited, newName);
            closeModals();
            loadCategories();
            displayTopics();
        }

        // Delete category with validation
        function deleteCategory() {
            const reassignTo = el.reassignCategorySelect.value || '';
            db.deleteCategory(currentCategoryBeingDeleted, reassignTo);
            closeModals();
            loadCategories();
            displayTopics();
        }

        // Event Listeners
        el.saveBtn.addEventListener('click', saveTopic);
        el.newBtn.addEventListener('click', resetForm);
        el.deleteBtn.addEventListener('click', deleteTopic);
        el.addCategoryBtn.addEventListener('click', addCategory);
        el.exportAllBtn.addEventListener('click', exportAllTopics);
        el.exportSelectedBtn.addEventListener('click', exportSelectedTopics);
        el.importBtn.addEventListener('click', importTopics);
        el.searchBtn.addEventListener('click', searchTopics);
        el.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchTopics();
        });
        el.editTopicBtn.addEventListener('click', editTopic);
        el.closeViewerBtn.addEventListener('click', () => {
            el.topicViewer.style.display = 'none';
            document.getElementById('editor-container').style.display = 'block';
            quill.enable(true);
            document.querySelector('#editor-container .ql-toolbar').style.display = '';
            document.querySelector('#editor-container .ql-container').style.border = '';
        });
        el.saveEditCategoryBtn.addEventListener('click', saveCategoryChanges);
        el.confirmDeleteCategoryBtn.addEventListener('click', deleteCategory);
        el.closeModalBtns.forEach(btn => {
            btn.addEventListener('click', closeModals);
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === el.editCategoryModal) {
                closeModals();
            }
            if (event.target === el.deleteCategoryModal) {
                closeModals();
            }
        });

        // Initialize
        loadCategories();
        displayTopics();
    </script>
</body>
</html>