
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Call Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        /* Custom scrollbar for table body */
        #admin-table-body::-webkit-scrollbar {
            width: 8px;
        }
        #admin-table-body::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        #admin-table-body::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        #admin-table-body::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800">Sysnet Service Management</h1>
        <p class="text-gray-600 mt-2">A simple system to manage customer service requests.</p>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-8">
        <!-- Customer View Section -->
        <section id="customer-view" class="active-view">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Submit a Service Request</h2>
            <form id="service-request-form" class="space-y-6">
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input type="text" id="company-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="issue-description" class="block text-sm font-medium text-gray-700">Describe the Issue</label>
                    <textarea id="issue-description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required></textarea>
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-blue-500 hover:bg-blue-600 rounded-md text-white font-semibold transition-colors duration-200">Submit Request</button>
            </form>
            <div id="submission-message" class="mt-6 p-4 rounded-md bg-blue-100 text-blue-700 hidden"></div>

            <div class="mt-10 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Check Request Status</h2>
                <div class="flex flex-col sm:flex-row sm:space-x-4">
                    <input type="text" id="status-check-id" placeholder="Enter your Service ID (e.g., SR0001)" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 mb-4 sm:mb-0">
                    <button id="check-status-btn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-gray-800 font-semibold transition-colors duration-200">Check Status</button>
                </div>
                <div id="status-result" class="mt-4 p-4 rounded-md bg-gray-100 hidden"></div>
            </div>
        </section>

        <!-- Admin View Section -->
        <section id="admin-view" class="hidden">
            <!-- Admin Login Form -->
            <div id="admin-login-panel" class="p-8 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800">Manager Login</h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="admin-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2" required>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-green-500 hover:bg-green-600 rounded-md text-white font-semibold transition-colors duration-200">Login</button>
                </form>
                <div id="login-message" class="mt-4 p-3 rounded-md text-sm text-center hidden"></div>
            </div>

            <!-- Service Call Dashboard (Hidden by default) -->
            <div id="admin-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-800">Service Call Dashboard</h2>
                    <button id="generate-report-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-md text-white font-semibold transition-colors duration-200">Generate Report</button>
                </div>
                <div id="loading-spinner" class="text-center p-8 text-gray-500 hidden">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p>Loading data...</p>
                </div>
                
                <div id="admin-table-container" class="overflow-hidden rounded-lg shadow-md mt-6">
                    <div class="h-[600px] overflow-y-scroll">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">History</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Service calls will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Message Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="modal-body"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Remark Modal -->
        <div id="remark-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add Completion Remark</h3>
                    <div class="mt-2 px-7 py-3">
                        <textarea id="remark-textarea" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Describe how the task was completed..."></textarea>
                    </div>
                    <div class="items-center px-4 py-3 space-y-2">
                        <button id="save-remark-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Save Remark
                        </button>
                        <button id="cancel-remark-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- View Toggler Buttons -->
        <div class="flex justify-center mt-8 space-x-4">
            <button id="service-request-form-btn" class="px-6 py-2 rounded-full text-white font-semibold transition-transform transform hover:scale-105 active:scale-95 shadow-md bg-blue-500 hover:bg-blue-600">Service Request Form</button>
            <button id="admin-view-btn" class="px-6 py-2 rounded-full text-white font-semibold transition-transform transform hover:scale-105 active:scale-95 shadow-md bg-green-500 hover:bg-green-600">Admin</button>
        </div>
    </main>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDoc, doc, updateDoc, onSnapshot, query, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase services
    let app, auth, db, userId;
    let unsubscribeAdminListener = null;
    let cachedServiceCalls = []; // Store the data for the report
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Engineers for the dropdown menu
    const ENGINEERS = ["Akash Rathore", "Jayant Pandit", "Abhay Sharma"];
    // Status options for the dropdown menu
    const STATUS_OPTIONS = ["Open", "In-Progress", "Closed", "On Hold"];
    const ADMIN_PASSWORD = "654123";

    // UI elements
    const customerView = document.getElementById('customer-view');
    const adminView = document.getElementById('admin-view');
    const serviceRequestFormBtn = document.getElementById('service-request-form-btn');
    const adminViewBtn = document.getElementById('admin-view-btn');
    const serviceRequestForm = document.getElementById('service-request-form');
    const submissionMessage = document.getElementById('submission-message');
    const statusCheckIdInput = document.getElementById('status-check-id');
    const checkStatusBtn = document.getElementById('check-status-btn');
    const statusResultDiv = document.getElementById('status-result');
    const adminTableBody = document.getElementById('admin-table-body');
    const loadingSpinner = document.getElementById('loading-spinner');
    const adminLoginPanel = document.getElementById('admin-login-panel');
    const adminDashboard = document.getElementById('admin-dashboard');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminPasswordInput = document.getElementById('admin-password');
    const loginMessage = document.getElementById('login-message');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const remarkModal = document.getElementById('remark-modal');
    const remarkTextarea = document.getElementById('remark-textarea');
    const saveRemarkBtn = document.getElementById('save-remark-btn');
    const cancelRemarkBtn = document.getElementById('cancel-remark-btn');

    // Utility to show the modal
    function showModal(title, body) {
        modalTitle.textContent = title;
        modalBody.innerHTML = body; // Use innerHTML to allow for HTML formatting in history view
        modal.classList.remove('hidden');
    }

    // Utility to close the modal
    modalCloseBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    // Toggle views
    function toggleView(view) {
        if (view === 'customer') {
            customerView.classList.remove('hidden');
            adminView.classList.add('hidden');
            // Unsubscribe the listener when leaving admin view
            if (unsubscribeAdminListener) {
                unsubscribeAdminListener();
            }
        } else {
            customerView.classList.add('hidden');
            adminView.classList.remove('hidden');
            adminLoginPanel.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
        }
    }

    serviceRequestFormBtn.addEventListener('click', () => toggleView('customer'));
    adminViewBtn.addEventListener('click', () => toggleView('admin'));

    // Handle admin login
    adminLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = adminPasswordInput.value;

        if (password === ADMIN_PASSWORD) {
            adminLoginPanel.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            loginMessage.textContent = '';
            // Start listening for data ONLY after successful login
            unsubscribeAdminListener = listenForServiceCalls();
        } else {
            loginMessage.textContent = 'Invalid password. Please try again.';
            loginMessage.classList.remove('hidden');
            loginMessage.classList.add('bg-red-100', 'text-red-700');
        }
    });

    // Initialize Firebase and Authentication
    async function initializeFirebase() {
        try {
            // Retrieve Firebase config and app ID from environment variables
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0) {
                showModal('Error', 'Firebase configuration is missing. The app cannot function without it.');
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Authenticate the user
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }

            userId = auth.currentUser?.uid || 'anonymous-user';

            console.log("Firebase initialized successfully. User ID:", userId);

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Error', 'Failed to initialize the application. Please try again.');
        }
    }

    // Handle new service request submission
    serviceRequestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('customer-name').value;
        const companyName = document.getElementById('company-name').value;
        const customerPhone = document.getElementById('customer-phone').value;
        const issueDescription = document.getElementById('issue-description').value;

        try {
            const serviceCallRef = collection(db, `artifacts/${APP_ID}/public/data/serviceCalls`);
            const countersRef = doc(db, `artifacts/${APP_ID}/public/data/counters`, 'serviceCallId');

            // Use a transaction to safely increment the counter
            const newCallId = await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(countersRef);
                const currentId = counterDoc.exists() ? counterDoc.data().lastId : 0;
                const nextId = currentId + 1;
                const formattedId = "SR" + String(nextId).padStart(4, '0');
                
                // Update the counter for the next transaction
                transaction.set(countersRef, { lastId: nextId });

                // Create the new service call document with the new ID
                const newDocRef = doc(serviceCallRef, formattedId);
                transaction.set(newDocRef, {
                    customerName,
                    companyName,
                    customerPhone,
                    issueDescription,
                    status: "Open",
                    assignedTo: "Unassigned",
                    createdAt: new Date().toISOString(),
                    updates: [{ status: "Open", timestamp: new Date().toISOString(), updatedBy: "Customer" }]
                });
                
                return formattedId;
            });
            
            submissionMessage.textContent = `Your service request has been submitted! Your Service ID is: ${newCallId}. Please save this ID to check the status.`;
            submissionMessage.classList.remove('hidden');
            serviceRequestForm.reset();
        } catch (error) {
            console.error("Transaction failed: ", error);
            showModal('Error', 'Failed to submit your request. Please check your connection and try again.');
        }
    });

    // Check status of a single service request
    checkStatusBtn.addEventListener('click', async () => {
        const callId = statusCheckIdInput.value.trim();
        if (!callId) {
            showModal('Invalid ID', 'Please enter a valid Service ID.');
            return;
        }

        try {
            const docRef = doc(db, `artifacts/${APP_ID}/public/data/serviceCalls`, callId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                statusResultDiv.innerHTML = `
                    <p class="font-bold text-gray-800">Service ID: <span class="font-normal">${callId}</span></p>
                    <p class="font-bold text-gray-800">Company Name: <span class="font-normal">${data.companyName}</span></p>
                    <p class="font-bold text-gray-800">Status: <span class="font-normal">${data.status}</span></p>
                    <p class="font-bold text-gray-800">Assigned Engineer: <span class="font-normal">${data.assignedTo}</span></p>
                    <p class="font-bold text-gray-800">Issue: <span class="font-normal">${data.issueDescription}</span></p>
                `;
                statusResultDiv.classList.remove('hidden');
            } else {
                statusResultDiv.innerHTML = `<p class="text-red-600">No service request found with that ID.</p>`;
                statusResultDiv.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error fetching document:", error);
            showModal('Error', 'Failed to check status. Please ensure the ID is correct and try again.');
        }
    });

    // Update service call in Firestore
    async function updateServiceCall(callId, field, value, remark = null) {
        try {
            const docRef = doc(db, `artifacts/${APP_ID}/public/data/serviceCalls`, callId);
            const updateData = {};
            
            // Get the current document to append to the updates array
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                console.error("Document not found for update:", callId);
                showModal('Error', 'Service call not found for update.');
                return;
            }

            const currentData = docSnap.data();
            const newUpdates = currentData.updates || [];

            if (field === 'assignedTo') {
                updateData.assignedTo = value;
                newUpdates.push({
                    assignedTo: value,
                    timestamp: new Date().toISOString(),
                    updatedBy: userId
                });
            } else if (field === 'status') {
                updateData.status = value;
                const updateEntry = {
                    status: value,
                    timestamp: new Date().toISOString(),
                    updatedBy: userId
                };
                if (value === 'Closed') {
                    updateData.closedAt = new Date().toISOString();
                    updateData.completionRemark = remark;
                    updateEntry.remark = remark;
                }
                newUpdates.push(updateEntry);
            }
            
            updateData.updates = newUpdates;

            await updateDoc(docRef, updateData);
        } catch (error) {
            console.error("Error updating document:", error);
            showModal('Error', 'Failed to update service call. Please try again.');
        }
    }

    // Render the admin dashboard table
    function renderAdminTable(calls) {
        adminTableBody.innerHTML = '';
        cachedServiceCalls = calls; // Cache the data for reporting
        calls.forEach(call => {
            const lastUpdate = call.updates.length > 0 ? new Date(call.updates[call.updates.length - 1].timestamp).toLocaleString() : 'N/A';
            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-100');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate" style="max-width: 100px;">${call.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${call.customerName}</td>
                <td class="px-6 py-4 whitespace-now-wrap text-sm text-gray-500 truncate" style="max-width: 150px;">${call.companyName || 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-500 truncate" style="max-width: 200px;">${call.issueDescription}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <select class="status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" data-id="${call.id}">
                        ${STATUS_OPTIONS.map(status => `<option value="${status}" ${call.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <select class="engineer-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" data-id="${call.id}">
                        <option value="Unassigned" ${call.assignedTo === "Unassigned" ? 'selected' : ''}>Unassigned</option>
                        ${ENGINEERS.map(engineer => `<option value="${engineer}" ${call.assignedTo === engineer ? 'selected' : ''}>${engineer}</option>`).join('')}
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(call.createdAt).toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastUpdate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 cursor-pointer hover:underline" onclick="viewHistory('${call.id}')">View</td>
            `;
            adminTableBody.appendChild(row);
        });

        // Add event listeners to the new dropdowns
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const callId = e.target.dataset.id;
                const newStatus = e.target.value;
                const originalStatus = STATUS_OPTIONS.find(s => e.target.options[e.target.options.selectedIndex].text === s);
                
                if (newStatus === 'Closed') {
                    // Show the remark modal
                    remarkModal.classList.remove('hidden');
                    
                    // Handle remark submission
                    saveRemarkBtn.onclick = () => {
                        const remark = remarkTextarea.value.trim();
                        if (remark) {
                            updateServiceCall(callId, 'status', newStatus, remark);
                            remarkModal.classList.add('hidden');
                            remarkTextarea.value = ''; // Clear textarea for next use
                        } else {
                            showModal('Remark Required', 'Please provide a completion remark before closing the request.');
                        }
                    };
                    
                    // Handle cancel button
                    cancelRemarkBtn.onclick = () => {
                        // Revert the dropdown to its original value if canceled
                        e.target.value = originalStatus;
                        remarkModal.classList.add('hidden');
                        remarkTextarea.value = '';
                    };
                } else {
                    updateServiceCall(callId, 'status', newStatus);
                }
            });
        });

        document.querySelectorAll('.engineer-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const callId = e.target.dataset.id;
                const newEngineer = e.target.value;
                updateServiceCall(callId, 'assignedTo', newEngineer);
            });
        });
    }
    
    // Function to generate and download a CSV report
    generateReportBtn.addEventListener('click', () => {
        if (cachedServiceCalls.length === 0) {
            showModal('Report Generation', 'There is no data to generate a report.');
            return;
        }

        const headers = ["ID", "Customer", "Company", "Issue", "Status", "Assigned To", "Created At", "Last Update", "Completion Remark"];
        
        // Map the cached data to a row for the CSV
        const rows = cachedServiceCalls.map(call => [
            `"${call.id}"`,
            `"${call.customerName}"`,
            `"${call.companyName || 'N/A'}"`,
            `"${call.issueDescription.replace(/"/g, '""')}"`, // Handle quotes in description
            `"${call.status}"`,
            `"${call.assignedTo}"`,
            `"${new Date(call.createdAt).toLocaleString()}"`,
            `"${call.updates.length > 0 ? new Date(call.updates[call.updates.length - 1].timestamp).toLocaleString() : 'N/A'}"`,
            `"${call.completionRemark ? call.completionRemark.replace(/"/g, '""') : 'N/A'}"`
        ]);
        
        // Join headers and rows into a single CSV string
        let csvContent = headers.join(",") + "\n" + rows.map(row => row.join(",")).join("\n");
        
        // Create and trigger a download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "service_calls_report.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // Function to view the history of a call
    window.viewHistory = async function(callId) {
        try {
            const docRef = doc(db, `artifacts/${APP_ID}/public/data/serviceCalls`, callId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                let historyContent = `<p class="mb-4">History for Service ID: <span class="font-bold">${callId}</span></p>`;
                if (data.updates && data.updates.length > 0) {
                    historyContent += `<ul class="list-disc list-inside space-y-1">`;
                    data.updates.forEach(update => {
                        historyContent += `<li><span class="font-semibold">${new Date(update.timestamp).toLocaleString()}:</span>`;
                        if (update.status) {
                            historyContent += ` Status changed to "${update.status}".`;
                        }
                        if (update.assignedTo && update.assignedTo !== "Unassigned") {
                            historyContent += ` Assigned to: ${update.assignedTo}.`;
                        }
                        if (update.remark) {
                            historyContent += ` Remark: ${update.remark}.`;
                        }
                        historyContent += ` Updated by: ${update.updatedBy}.</li>`;
                    });
                    historyContent += `</ul>`;
                } else {
                    historyContent += `<p>No history found for this request.</p>`;
                }
                showModal('Service Call History', historyContent);
            } else {
                showModal('Error', 'Service call not found.');
            }
        } catch (error) {
            console.error("Error viewing history:", error);
            showModal('Error', 'Failed to retrieve call history.');
        }
    }

    // Real-time listener for the admin dashboard
    function listenForServiceCalls() {
        if (!db) return;

        const callsRef = collection(db, `artifacts/${APP_ID}/public/data/serviceCalls`);
        const q = query(callsRef);

        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const serviceCalls = [];
            querySnapshot.forEach((doc) => {
                serviceCalls.push({ id: doc.id, ...doc.data() });
            });
            // Sort in memory to avoid Firestore index issues
            serviceCalls.sort((a, b) => {
                const dateA = a.updates && a.updates.length > 0 ? new Date(a.updates[a.updates.length - 1].timestamp) : new Date(a.createdAt);
                const dateB = b.updates && b.updates.length > 0 ? new Date(b.updates[b.updates.length - 1].timestamp) : new Date(b.createdAt);
                return dateB - dateA;
            });
            renderAdminTable(serviceCalls);
            loadingSpinner.classList.add('hidden');
        }, (error) => {
            console.error("Error listening to service calls:", error);
            loadingSpinner.classList.add('hidden');
            showModal('Data Error', 'Failed to load real-time data from the database.');
        });
        return unsubscribe;
    }

    // Start the app when the window loads
    window.onload = initializeFirebase;
</script>

</body>
</html>