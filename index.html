
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Call Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        /* Custom scrollbar for table body */
        #admin-table-body::-webkit-scrollbar {
            width: 8px;
        }
        #admin-table-body::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        #admin-table-body::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        #admin-table-body::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800">Sysnet Service Management</h1>
        <p class="text-gray-600 mt-2">A simple system to manage customer service requests.</p>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-8">
        <!-- Customer View Section -->
        <section id="customer-view" class="active-view">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Submit a Service Request</h2>
            <form id="service-request-form" class="space-y-6">
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="customer-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input type="text" id="company-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="customer-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="issue-description" class="block text-sm font-medium text-gray-700">Describe the Issue</label>
                    <textarea id="issue-description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required></textarea>
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-blue-500 hover:bg-blue-600 rounded-md text-white font-semibold transition-colors duration-200">Submit Request</button>
            </form>
            <div id="submission-message" class="mt-6 p-4 rounded-md bg-blue-100 text-blue-700 hidden"></div>

            <div class="mt-10 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Check Request Status</h2>
                <div class="flex flex-col sm:flex-row sm:space-x-4">
                    <input type="text" id="status-check-id" placeholder="Enter your Service ID (e.g., SR0001)" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 mb-4 sm:mb-0">
                    <button id="check-status-btn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-gray-800 font-semibold transition-colors duration-200">Check Status</button>
                </div>
                <div id="status-result" class="mt-4 p-4 rounded-md bg-gray-100 hidden"></div>
            </div>
        </section>

        <!-- Admin View Section -->
        <section id="admin-view" class="hidden">
            <!-- Admin Login Form -->
            <div id="admin-login-panel" class="p-8 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800">Manager Login</h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="admin-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2" required>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-green-500 hover:bg-green-600 rounded-md text-white font-semibold transition-colors duration-200">Login</button>
                </form>
                <div id="login-message" class="mt-4 p-3 rounded-md text-sm text-center hidden"></div>
            </div>

            <!-- Service Call Dashboard (Hidden by default) -->
            <div id="admin-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-800">Service Call Dashboard</h2>
                    <button id="generate-report-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-md text-white font-semibold transition-colors duration-200">Generate Report</button>
                </div>
                <div id="loading-spinner" class="text-center p-8 text-gray-500">
                    <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p>Loading data...</p>
                </div>
                
                <!-- New section for adding engineers -->
                <div class="p-6 rounded-lg bg-gray-100 mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Add New Engineer</h3>
                    <form id="add-engineer-form" class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="new-engineer-name" class="block text-sm font-medium text-gray-700">Engineer Name</label>
                            <input type="text" id="new-engineer-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2" required>
                        </div>
                        <button type="submit" class="px-6 py-2 bg-purple-500 hover:bg-purple-600 rounded-md text-white font-semibold transition-colors duration-200">Add Engineer</button>
                    </form>
                    <div id="engineer-message" class="mt-4 p-3 rounded-md text-sm text-center hidden"></div>
                </div>

                <div id="admin-table-container" class="overflow-hidden rounded-lg shadow-md mt-6 hidden">
                    <div class="h-[600px] overflow-y-scroll" id="table-scroll-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">History</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Service calls will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Message Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="modal-body"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Remark Modal -->
        <div id="remark-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add Completion Remark</h3>
                    <div class="mt-2 px-7 py-3">
                        <textarea id="remark-textarea" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Describe how the task was completed..."></textarea>
                    </div>
                    <div class="items-center px-4 py-3 space-y-2">
                        <button id="save-remark-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Save Remark
                        </button>
                        <button id="cancel-remark-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- View Toggler Buttons -->
        <div class="flex justify-center mt-8 space-x-4">
            <button id="service-request-form-btn" class="px-6 py-2 rounded-full text-white font-semibold transition-transform transform hover:scale-105 active:scale-95 shadow-md bg-blue-500 hover:bg-blue-600">Service Request Form</button>
            <button id="admin-view-btn" class="px-6 py-2 rounded-full text-white font-semibold transition-transform transform hover:scale-105 active:scale-95 shadow-md bg-green-500 hover:bg-green-600">Admin</button>
        </div>
    </main>
</div>

<!-- All application logic is in a single script tag to make it self-contained -->
<script>
    // --- IMPORTANT: UPDATE THIS URL FOR PUBLIC HOSTING ---
    // Change 'http://localhost:3000' to the actual URL of your deployed backend server.
    // For example: const API_URL = 'https://your-backend-app.onrender.com/api';
    const API_URL = 'http://localhost:3000/api';
    
    // Status options for the dropdown menu
    const STATUS_OPTIONS = ["Open", "In-Progress", "Closed", "On Hold"];
    const ADMIN_PASSWORD = "654123";

    // UI elements
    const customerView = document.getElementById('customer-view');
    const adminView = document.getElementById('admin-view');
    const serviceRequestFormBtn = document.getElementById('service-request-form-btn');
    const adminViewBtn = document.getElementById('admin-view-btn');
    const serviceRequestForm = document.getElementById('service-request-form');
    const submissionMessage = document.getElementById('submission-message');
    const statusCheckIdInput = document.getElementById('status-check-id');
    const checkStatusBtn = document.getElementById('check-status-btn');
    const statusResultDiv = document.getElementById('status-result');
    const adminTableBody = document.getElementById('admin-table-body');
    const loadingSpinner = document.getElementById('loading-spinner');
    const adminLoginPanel = document.getElementById('admin-login-panel');
    const adminDashboard = document.getElementById('admin-dashboard');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminPasswordInput = document.getElementById('admin-password');
    const loginMessage = document.getElementById('login-message');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const remarkModal = document.getElementById('remark-modal');
    const remarkTextarea = document.getElementById('remark-textarea');
    const saveRemarkBtn = document.getElementById('save-remark-btn');
    const cancelRemarkBtn = document = document.getElementById('cancel-remark-btn');
    const adminTableContainer = document.getElementById('admin-table-container');

    // New UI elements for adding engineers
    const addEngineerForm = document.getElementById('add-engineer-form');
    const newEngineerNameInput = document.getElementById('new-engineer-name');
    const engineerMessageDiv = document.getElementById('engineer-message');

    // Utility to show the modal
    function showModal(title, body) {
        modalTitle.textContent = title;
        modalBody.innerHTML = body; // Use innerHTML to allow for HTML formatting in history view
        modal.classList.remove('hidden');
    }

    // Utility to close the modal
    modalCloseBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    // Toggle views
    function toggleView(view) {
        if (view === 'customer') {
            customerView.classList.remove('hidden');
            adminView.classList.add('hidden');
        } else {
            customerView.classList.add('hidden');
            adminView.classList.remove('hidden');
            adminLoginPanel.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
        }
    }

    serviceRequestFormBtn.addEventListener('click', () => toggleView('customer'));
    adminViewBtn.addEventListener('click', () => toggleView('admin'));

    // Handle admin login
    adminLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = adminPasswordInput.value;

        if (password === ADMIN_PASSWORD) {
            adminLoginPanel.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            loginMessage.textContent = '';
            // Load the dashboard data after successful login
            fetchAndRenderAdminTable();
        } else {
            loginMessage.textContent = 'Invalid password. Please try again.';
            loginMessage.classList.remove('hidden');
            loginMessage.classList.add('bg-red-100', 'text-red-700');
        }
    });

    // Handle new service request submission
    serviceRequestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('customer-name').value;
        const companyName = document.getElementById('company-name').value;
        const customerPhone = document.getElementById('customer-phone').value;
        const issueDescription = document.getElementById('issue-description').value;

        try {
            const response = await fetch(`${API_URL}/calls`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customerName, companyName, customerPhone, issueDescription }),
            });
            const data = await response.json();

            if (response.ok) {
                submissionMessage.textContent = `Your service request has been submitted! Your Service ID is: ${data.id}. Please save this ID to check the status.`;
                submissionMessage.classList.remove('hidden');
                serviceRequestForm.reset();
            } else {
                showModal('Submission Failed', data.error || 'Something went wrong.');
            }
        } catch (error) {
            console.error('Submission error:', error);
            showModal('Submission Error', 'Failed to connect to the server. Please ensure the backend is running.');
        }
    });

    // Handle adding a new engineer
    addEngineerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newEngineerName = newEngineerNameInput.value.trim();
        if (!newEngineerName) return;

        try {
            const response = await fetch(`${API_URL}/engineers`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: newEngineerName }),
            });
            const data = await response.json();

            if (response.ok) {
                engineerMessageDiv.textContent = `"${data.name}" has been added successfully.`;
                engineerMessageDiv.classList.remove('hidden');
                engineerMessageDiv.classList.add('bg-green-100', 'text-green-700');
                newEngineerNameInput.value = ''; // Clear the input
                // Refresh the table to update dropdowns
                fetchAndRenderAdminTable();
            } else {
                showModal('Error Adding Engineer', data.error || 'Something went wrong.');
            }
        } catch (error) {
            console.error('Add engineer error:', error);
            showModal('Error Adding Engineer', 'Failed to connect to the server.');
        }
    });

    // Check status of a single service request
    checkStatusBtn.addEventListener('click', async () => {
        const callId = statusCheckIdInput.value.trim().toUpperCase();
        if (!callId) {
            showModal('Invalid ID', 'Please enter a valid Service ID.');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/calls/${callId}`);
            const call = await response.json();
            
            if (response.ok) {
                statusResultDiv.innerHTML = `
                    <p class="font-bold text-gray-800">Service ID: <span class="font-normal">${call.id}</span></p>
                    <p class="font-bold text-gray-800">Company Name: <span class="font-normal">${call.company_name}</span></p>
                    <p class="font-bold text-gray-800">Status: <span class="font-normal">${call.status}</span></p>
                    <p class="font-bold text-gray-800">Assigned Engineer: <span class="font-normal">${call.assigned_to}</span></p>
                    <p class="font-bold text-gray-800">Issue: <span class="font-normal">${call.issue_description}</span></p>
                `;
                statusResultDiv.classList.remove('hidden');
            } else {
                statusResultDiv.innerHTML = `<p class="text-red-600">No service request found with that ID.</p>`;
                statusResultDiv.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Status check error:', error);
            showModal('Error', 'Failed to connect to the server.');
        }
    });

    // Update service call on the backend
    async function updateServiceCall(callId, field, value, remark = null) {
        try {
            const response = await fetch(`${API_URL}/calls/${callId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ field, value, remark }),
            });
            
            if (!response.ok) {
                const data = await response.json();
                showModal('Update Failed', data.error || 'Something went wrong.');
            }
            fetchAndRenderAdminTable(); // Refresh the table after a successful update
        } catch (error) {
            console.error('Update error:', error);
            showModal('Update Error', 'Failed to connect to the server.');
        }
    }
    
    // Fetch and render the admin dashboard table
    async function fetchAndRenderAdminTable() {
        loadingSpinner.classList.remove('hidden');
        adminTableContainer.classList.add('hidden');
        adminTableBody.innerHTML = '';
        
        try {
            const [callsResponse, engineersResponse] = await Promise.all([
                fetch(`${API_URL}/calls`),
                fetch(`${API_URL}/engineers`)
            ]);
            const serviceCalls = await callsResponse.json();
            const engineersList = await engineersResponse.json();

            serviceCalls.forEach(call => {
                const updates = call.updates || [];
                const lastUpdate = updates.length > 0 ? new Date(updates[updates.length - 1].timestamp).toLocaleString() : 'N/A';
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate" style="max-width: 100px;">${call.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${call.customer_name}</td>
                    <td class="px-6 py-4 whitespace-now-wrap text-sm text-gray-500 truncate" style="max-width: 150px;">${call.company_name || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 truncate" style="max-width: 200px;">${call.issue_description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <select class="status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" data-id="${call.id}">
                            ${STATUS_OPTIONS.map(status => `<option value="${status}" ${call.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <select class="engineer-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" data-id="${call.id}">
                            <option value="Unassigned" ${call.assigned_to === "Unassigned" ? 'selected' : ''}>Unassigned</option>
                            ${engineersList.map(engineer => `<option value="${engineer}" ${call.assigned_to === engineer ? 'selected' : ''}>${engineer}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(call.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastUpdate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 cursor-pointer hover:underline" onclick="viewHistory('${call.id}')">View</td>
                `;
                adminTableBody.appendChild(row);
            });

            // Add event listeners to the new dropdowns
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const callId = e.target.dataset.id;
                    const newStatus = e.target.value;
                    const originalStatus = STATUS_OPTIONS.find(s => e.target.options[e.target.options.selectedIndex].text === s);
                    
                    if (newStatus === 'Closed') {
                        remarkModal.classList.remove('hidden');
                        
                        saveRemarkBtn.onclick = () => {
                            const remark = remarkTextarea.value.trim();
                            if (remark) {
                                updateServiceCall(callId, 'status', newStatus, remark);
                                remarkModal.classList.add('hidden');
                                remarkTextarea.value = '';
                            } else {
                                showModal('Remark Required', 'Please provide a completion remark before closing the request.');
                            }
                        };
                        
                        cancelRemarkBtn.onclick = () => {
                            e.target.value = originalStatus;
                            remarkModal.classList.add('hidden');
                            remarkTextarea.value = '';
                        };
                    } else {
                        updateServiceCall(callId, 'status', newStatus);
                    }
                });
            });

            document.querySelectorAll('.engineer-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const callId = e.target.dataset.id;
                    const newEngineer = e.target.value;
                    updateServiceCall(callId, 'assignedTo', newEngineer);
                });
            });
            
        } catch (error) {
            console.error('Fetch error:', error);
            showModal('Error', 'Failed to connect to the server. Please ensure the backend is running and the URL is correct.');
        } finally {
            loadingSpinner.classList.add('hidden');
            adminTableContainer.classList.remove('hidden');
        }
    }
    
    // Function to generate and download a CSV report
    generateReportBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`${API_URL}/calls`);
            if (!response.ok) {
                showModal('Report Generation Failed', 'Failed to fetch data from the server.');
                return;
            }
            const serviceCalls = await response.json();

            if (serviceCalls.length === 0) {
                showModal('Report Generation', 'There is no data to generate a report.');
                return;
            }

            const headers = ["ID", "Customer", "Company", "Issue", "Status", "Assigned To", "Created At", "Last Update", "Completion Remark"];
            
            const rows = serviceCalls.map(call => [
                `"${call.id}"`,
                `"${call.customer_name}"`,
                `"${call.company_name || 'N/A'}"`,
                `"${call.issue_description.replace(/"/g, '""')}"`,
                `"${call.status}"`,
                `"${call.assigned_to}"`,
                `"${new Date(call.created_at).toLocaleString()}"`,
                `"${(call.updates && call.updates.length > 0) ? new Date(call.updates[call.updates.length - 1].timestamp).toLocaleString() : 'N/A'}"`,
                `"${call.completion_remark ? call.completion_remark.replace(/"/g, '""') : 'N/A'}"`
            ]);
            
            let csvContent = headers.join(",") + "\n" + rows.map(row => row.join(",")).join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "service_calls_report.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Report generation error:', error);
            showModal('Report Error', 'Failed to generate report due to server error.');
        }
    });

    // Function to view the history of a call
    window.viewHistory = async function(callId) {
        try {
            const response = await fetch(`${API_URL}/calls/${callId}`);
            if (!response.ok) {
                showModal('Error', 'Service call not found.');
                return;
            }
            const call = await response.json();
            const updates = call.updates || [];

            let historyContent = `<p class="mb-4">History for Service ID: <span class="font-bold">${call.id}</span></p>`;
            if (updates.length > 0) {
                historyContent += `<ul class="list-disc list-inside space-y-1">`;
                updates.forEach(update => {
                    historyContent += `<li><span class="font-semibold">${new Date(update.timestamp).toLocaleString()}:</span>`;
                    if (update.status) {
                        historyContent += ` Status changed to "${update.status}".`;
                    }
                    if (update.assignedTo && update.assignedTo !== "Unassigned") {
                        historyContent += ` Assigned to: ${update.assignedTo}.`;
                    }
                    if (update.remark) {
                        historyContent += ` Remark: ${update.remark}.`;
                    }
                    historyContent += ` Updated by: ${update.updatedBy}.</li>`;
                });
                historyContent += `</ul>`;
            } else {
                historyContent += `<p>No history found for this request.</p>`;
            }
            showModal('Service Call History', historyContent);
        } catch (error) {
            console.error('History view error:', error);
            showModal('Error', 'Failed to retrieve history from the server.');
        }
    }

</script>

</body>
</html>
