<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Digital Diary - Spread your Knowledge with Your Friends/Groups (Cloud Edition)</title>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase App (required for Firebase products) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button.delete { background: #f44336; }
        button.export { background: #ff9800; }
        button.import { background: #9c27b0; }
        button.category { background: #607d8b; }
        button.pdf { background: #e91e63; }
        button.cloud { background: #2196F3; }
        .topic-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topic-item:hover { background: #eee; }
        .topic-category {
            font-size: 0.8em;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .category-filter {
            margin-bottom: 15px;
        }
        .category-tag {
            display: inline-block;
            padding: 3px 8px;
            background: #e0e0e0;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
            margin-right: 5px;
        }
        .category-tag:hover { background: #bdbdbd; }
        .category-tag.active {
            background: #4CAF50;
            color: white;
        }
        .search-results { margin-top: 20px; }
        #editor-container {
            height: 300px;
            margin-bottom: 15px;
        }
        .topic-actions { display: flex; gap: 5px; }
        .action-btn {
            padding: 2px 6px;
            font-size: 0.8em;
        }
        .topic-select { margin-right: 10px; }
        .view-topic { cursor: pointer; flex-grow: 1; }
        #allTopicsTag { font-weight: bold; }
        
        /* New styles for topic viewer */
        .topic-viewer {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            display: none;
        }
        .edit-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .view-mode .ql-toolbar {
            display: none;
        }
        .view-mode .ql-container {
            border: none;
        }
        .view-mode .ql-editor {
            padding: 0;
        }
        #topicContent {
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        /* Auth styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }
        .auth-tab.active {
            border-bottom: 2px solid #4CAF50;
            font-weight: bold;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="registerTab">Register</div>
            </div>
            
            <div id="loginForm" class="auth-form active">
                <h3>Login</h3>
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button id="loginBtn">Login</button>
                <div id="loginError" style="color: red; margin-top: 10px;"></div>
            </div>
            
            <div id="registerForm" class="auth-form">
                <h3>Register</h3>
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="password" id="registerPassword" placeholder="Password (min 6 chars)">
                <button id="registerBtn">Register</button>
                <div id="registerError" style="color: red; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="appContent" style="display: none;">
        <div class="user-info">
            <span id="userEmail"></span>
            <button id="logoutBtn">Logout</button>
        </div>
        
        <h1>Advanced Topic Manager (Cloud Edition)</h1>
        
        <div class="container">
            <div class="panel">
                <h2>Create/Edit Topic</h2>
                <input type="text" id="topicTitle" placeholder="Title">
                <select id="topicCategory">
                    <option value="">-- Select Category --</option>
                </select>
                <input type="text" id="newCategory" placeholder="New category name">
                <button id="addCategoryBtn" class="category">Add Category</button>
                
                <div id="editor-container"></div>
                
                <div class="topic-viewer" id="topicViewer">
                    <div class="edit-bar">
                        <h3 id="viewerTitle"></h3>
                        <div>
                            <button id="editTopicBtn">Edit</button>
                            <button id="closeViewerBtn">Close</button>
                        </div>
                    </div>
                    <div id="topicContent"></div>
                </div>
                
                <div class="button-group">
                    <button id="saveBtn">Save</button>
                    <button id="newBtn">New</button>
                    <button id="deleteBtn" class="delete">Delete</button>
                </div>
                
                <h2>Import/Export</h2>
                <button id="exportAllBtn" class="export">Export All</button>
                <button id="exportSelectedBtn" class="export">Export Selected</button>
                <button id="importBtn" class="import">Import</button>
                <input type="file" id="fileInput" style="display:none">
                
                <h2>Search</h2>
                <input type="text" id="searchInput" placeholder="Search...">
                <button id="searchBtn">Search</button>
            </div>
            
            <div class="panel">
                <h2>Topics</h2>
                <div class="category-filter">
                    <span class="category-tag active" id="allTopicsTag" data-category="">All Topics</span>
                </div>
                <div id="topicList"></div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - Replace with your own config
        const firebaseConfig = {
            apiKey: "AIzaSyAn7Arht0D2u5Efq8kAgZrfRKjYhjYfgQg",
  authDomain: "topicmanager-5c6dd.firebaseapp.com",
  projectId: "topicmanager-5c6dd",
  storageBucket: "topicmanager-5c6dd.firebasestorage.app",
  messagingSenderId: "1015877032691",
  appId: "1:1015877032691:web:6b41ae3338034d79847586",
  measurementId: "G-7YZBGNCFR8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Quill editor
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['clean'],
                    ['link', 'image', 'video']
                ]
            },
            placeholder: 'Write your content here...'
        });

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // DOM Elements
        const el = {
            authContainer: document.getElementById('authContainer'),
            appContent: document.getElementById('appContent'),
            loginTab: document.getElementById('loginTab'),
            registerTab: document.getElementById('registerTab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            loginBtn: document.getElementById('loginBtn'),
            loginError: document.getElementById('loginError'),
            registerEmail: document.getElementById('registerEmail'),
            registerPassword: document.getElementById('registerPassword'),
            registerBtn: document.getElementById('registerBtn'),
            registerError: document.getElementById('registerError'),
            userEmail: document.getElementById('userEmail'),
            logoutBtn: document.getElementById('logoutBtn'),
            title: document.getElementById('topicTitle'),
            category: document.getElementById('topicCategory'),
            newCategory: document.getElementById('newCategory'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            saveBtn: document.getElementById('saveBtn'),
            newBtn: document.getElementById('newBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            exportAllBtn: document.getElementById('exportAllBtn'),
            exportSelectedBtn: document.getElementById('exportSelectedBtn'),
            importBtn: document.getElementById('importBtn'),
            fileInput: document.getElementById('fileInput'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            topicList: document.getElementById('topicList'),
            searchResults: document.getElementById('searchResults'),
            categoryFilter: document.querySelector('.category-filter'),
            allTopicsTag: document.getElementById('allTopicsTag'),
            topicViewer: document.getElementById('topicViewer'),
            viewerTitle: document.getElementById('viewerTitle'),
            topicContent: document.getElementById('topicContent'),
            editTopicBtn: document.getElementById('editTopicBtn'),
            closeViewerBtn: document.getElementById('closeViewerBtn')
        };

        let currentTopicId = null;
        let selectedCategory = '';
        let currentUser = null;
        let topics = [];
        let categories = [];

        // Auth functions
        function showAuth() {
            el.authContainer.style.display = 'flex';
            el.appContent.style.display = 'none';
        }

        function showApp() {
            el.authContainer.style.display = 'none';
            el.appContent.style.display = 'block';
        }

        // Auth event listeners
        el.loginTab.addEventListener('click', () => {
            el.loginTab.classList.add('active');
            el.registerTab.classList.remove('active');
            el.loginForm.classList.add('active');
            el.registerForm.classList.remove('active');
        });

        el.registerTab.addEventListener('click', () => {
            el.registerTab.classList.add('active');
            el.loginTab.classList.remove('active');
            el.registerForm.classList.add('active');
            el.loginForm.classList.remove('active');
        });

        el.loginBtn.addEventListener('click', async () => {
            const email = el.loginEmail.value;
            const password = el.loginPassword.value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                el.loginError.textContent = '';
            } catch (error) {
                el.loginError.textContent = error.message;
            }
        });

        el.registerBtn.addEventListener('click', async () => {
            const email = el.registerEmail.value;
            const password = el.registerPassword.value;
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                el.registerError.textContent = '';
            } catch (error) {
                el.registerError.textContent = error.message;
            }
        });

        el.logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                el.userEmail.textContent = user.email;
                showApp();
                await loadData();
            } else {
                currentUser = null;
                showAuth();
            }
        });

        // Load data from Firestore
        async function loadData() {
            if (!currentUser) return;
            
            // Load categories
            const categoriesSnapshot = await db.collection('users')
                .doc(currentUser.uid)
                .collection('categories')
                .get();
                
            categories = [];
            categoriesSnapshot.forEach(doc => {
                categories.push(doc.data().name);
            });
            
            // Load topics
            const topicsSnapshot = await db.collection('users')
                .doc(currentUser.uid)
                .collection('topics')
                .orderBy('updatedAt', 'desc')
                .get();
                
            topics = [];
            topicsSnapshot.forEach(doc => {
                topics.push({ id: doc.id, ...doc.data() });
            });
            
            loadCategories();
            displayTopics();
        }

        // Load categories into dropdown
        function loadCategories() {
            el.category.innerHTML = '<option value="">-- Select Category --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                el.category.appendChild(option);
            });
            
            // Update category filter (keep "All Topics" first)
            el.categoryFilter.innerHTML = '';
            const allSpan = document.createElement('span');
            allSpan.className = 'category-tag active';
            allSpan.id = 'allTopicsTag';
            allSpan.textContent = 'All Topics';
            allSpan.dataset.category = '';
            allSpan.addEventListener('click', () => filterByCategory(''));
            el.categoryFilter.appendChild(allSpan);
            
            categories.forEach(cat => {
                const span = document.createElement('span');
                span.className = 'category-tag';
                if (cat === selectedCategory) span.classList.add('active');
                span.textContent = cat;
                span.dataset.category = cat;
                span.addEventListener('click', () => filterByCategory(cat));
                el.categoryFilter.appendChild(span);
            });
        }

        // Display topics with proper filtering
        function displayTopics() {
            let filteredTopics = topics;
            
            // Filter by category if one is selected (empty string shows all)
            if (selectedCategory !== '') {
                filteredTopics = filteredTopics.filter(t => t.category === selectedCategory);
            }
            
            el.topicList.innerHTML = '';
            
            if (filteredTopics.length === 0) {
                el.topicList.innerHTML = '<p>No topics found</p>';
                return;
            }
            
            filteredTopics.forEach(topic => {
                const div = document.createElement('div');
                div.className = 'topic-item';
                div.dataset.id = topic.id;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'topic-select';
                checkbox.dataset.id = topic.id;
                
                const viewDiv = document.createElement('div');
                viewDiv.className = 'view-topic';
                viewDiv.innerHTML = `
                    <strong>${topic.title}</strong>
                    <div style="font-size:0.8em;color:#666;">
                        ${new Date(topic.updatedAt).toLocaleString()}
                    </div>
                `;
                viewDiv.addEventListener('click', () => viewTopic(topic.id));
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'topic-category';
                categorySpan.textContent = topic.category || 'Uncategorized';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'topic-actions';
                
                const pdfBtn = document.createElement('button');
                pdfBtn.className = 'action-btn pdf';
                pdfBtn.textContent = 'PDF';
                pdfBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exportToPDF(topic);
                });
                
                actionsDiv.appendChild(pdfBtn);
                
                div.appendChild(checkbox);
                div.appendChild(viewDiv);
                div.appendChild(categorySpan);
                div.appendChild(actionsDiv);
                
                el.topicList.appendChild(div);
            });
        }

        // Filter by category
        function filterByCategory(category) {
            selectedCategory = category;
            
            // Update active tags
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.toggle('active', tag.dataset.category === category);
            });
            
            displayTopics();
        }

        // View topic in read-only mode
        function viewTopic(id) {
            const topic = topics.find(t => t.id === id);
            if (topic) {
                currentTopicId = id;
                el.viewerTitle.textContent = topic.title;
                el.topicContent.innerHTML = topic.content;
                
                // Highlight the topic in the list
                document.querySelectorAll('.topic-item').forEach(item => {
                    item.style.background = item.dataset.id === id ? '#e6f7ff' : '#f9f9f9';
                });
                
                // Show viewer and hide editor
                el.topicViewer.style.display = 'block';
                document.getElementById('editor-container').style.display = 'none';
                quill.enable(false);
                document.querySelector('#editor-container .ql-toolbar').style.display = 'none';
                document.querySelector('#editor-container .ql-container').style.border = 'none';
            }
        }

        // Edit existing topic
        function editTopic() {
            const topic = topics.find(t => t.id === currentTopicId);
            if (topic) {
                el.title.value = topic.title;
                el.category.value = topic.category || '';
                quill.root.innerHTML = topic.content;
                
                // Switch to edit mode
                el.topicViewer.style.display = 'none';
                document.getElementById('editor-container').style.display = 'block';
                quill.enable(true);
                document.querySelector('#editor-container .ql-toolbar').style.display = '';
                document.querySelector('#editor-container .ql-container').style.border = '';
                el.title.focus();
            }
        }

        // Save topic
        async function saveTopic() {
            if (!currentUser) return;
            
            const title = el.title.value.trim();
            if (!title) return alert('Title is required');
            
            const content = quill.root.innerHTML;
            const category = el.category.value || '';
            
            const topicData = {
                title,
                content,
                category,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (currentTopicId) {
                    // Update existing topic
                    await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('topics')
                        .doc(currentTopicId)
                        .update(topicData);
                        
                    // Update local data
                    const index = topics.findIndex(t => t.id === currentTopicId);
                    if (index !== -1) {
                        topics[index] = { ...topics[index], ...topicData };
                    }
                } else {
                    // Create new topic
                    topicData.createdAt = new Date().toISOString();
                    const docRef = await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('topics')
                        .add(topicData);
                    
                    // Add to local data
                    topics.push({ id: docRef.id, ...topicData });
                }
                
                resetForm();
                loadCategories();
                displayTopics();
            } catch (error) {
                console.error("Error saving topic:", error);
                alert("Error saving topic. Please try again.");
            }
        }

        // Add new category
        async function addCategory() {
            if (!currentUser) return;
            
            const name = el.newCategory.value.trim();
            if (!name) return;
            
            if (!categories.includes(name)) {
                try {
                    // Add to Firestore
                    await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('categories')
                        .add({ name });
                    
                    // Add to local data
                    categories.push(name);
                    el.newCategory.value = '';
                    loadCategories();
                } catch (error) {
                    console.error("Error adding category:", error);
                    alert("Error adding category. Please try again.");
                }
            }
        }

        // Delete topic
        async function deleteTopic() {
            if (!currentUser || !currentTopicId) return alert('No topic selected');
            
            if (confirm('Delete this topic?')) {
                try {
                    // Delete from Firestore
                    await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('topics')
                        .doc(currentTopicId)
                        .delete();
                    
                    // Remove from local data
                    topics = topics.filter(t => t.id !== currentTopicId);
                    
                    resetForm();
                    displayTopics();
                } catch (error) {
                    console.error("Error deleting topic:", error);
                    alert("Error deleting topic. Please try again.");
                }
            }
        }

        // Reset form
        function resetForm() {
            currentTopicId = null;
            el.title.value = '';
            el.category.value = '';
            quill.root.innerHTML = '';
            el.title.focus();
            
            // Hide viewer and show editor
            el.topicViewer.style.display = 'none';
            document.getElementById('editor-container').style.display = 'block';
            quill.enable(true);
            document.querySelector('#editor-container .ql-toolbar').style.display = '';
            document.querySelector('#editor-container .ql-container').style.border = '';
            
            // Remove highlighting from topics list
            document.querySelectorAll('.topic-item').forEach(item => {
                item.style.background = '#f9f9f9';
            });
        }

        // Export to PDF
        function exportToPDF(topic) {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(33, 150, 243);
            doc.text(topic.title, 15, 20);
            
            // Add category if exists
            if (topic.category) {
                doc.setFontSize(12);
                doc.setTextColor(128, 128, 128);
                doc.text(`Category: ${topic.category}`, 15, 30);
            }
            
            // Add date
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Last updated: ${new Date(topic.updatedAt).toLocaleString()}`, 15, 40);
            
            // Add content (simple text version)
            const content = document.createElement('div');
            content.innerHTML = topic.content;
            const textContent = content.textContent || "";
            
            const lines = doc.splitTextToSize(textContent, 180);
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(lines, 15, 50);
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Exported from Topic Manager on ${new Date().toLocaleString()}`, 15, doc.internal.pageSize.height - 10);
            
            // Save the PDF
            doc.save(`${topic.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
        }

        // Export all topics
        function exportAllTopics() {
            if (topics.length === 0) return alert('No topics to export');
            
            const json = JSON.stringify(topics, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all-topics-export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export selected topics
        function exportSelectedTopics() {
            const selected = Array.from(document.querySelectorAll('.topic-select:checked'));
            if (selected.length === 0) return alert('No topics selected');
            
            const topicsToExport = selected.map(checkbox => {
                return topics.find(t => t.id === checkbox.dataset.id);
            }).filter(Boolean);
            
            const json = JSON.stringify(topicsToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected-topics-export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import topics
        function importTopics() {
            el.fileInput.click();
        }

        // Handle file import
        el.fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTopics = JSON.parse(e.target.result);
                    if (!Array.isArray(importedTopics)) throw new Error('Invalid format');
                    
                    importTopicSelection(importedTopics);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // Import topic selection
        async function importTopicSelection(importedTopics) {
            if (!currentUser) return;
            
            const existingIds = topics.map(t => t.id);
            const newTopics = importedTopics.filter(t => !existingIds.includes(t.id));
            
            if (newTopics.length === 0) {
                return alert('No new topics to import');
            }
            
            let html = '<h3>Select Topics to Import</h3>';
            html += '<div style="margin-bottom:10px;">';
            html += '<input type="checkbox" id="selectAll" checked> ';
            html += '<label for="selectAll">Select All</label>';
            html += '</div>';
            
            newTopics.forEach(topic => {
                html += `
                    <div style="margin-bottom:5px;">
                        <input type="checkbox" class="import-checkbox" id="imp-${topic.id}" checked>
                        <label for="imp-${topic.id}">
                            <strong>${topic.title || 'Untitled'}</strong>
                            ${topic.category ? `<span class="topic-category">${topic.category}</span>` : ''}
                            <div style="font-size:0.8em;color:#666;">
                                ${topic.updatedAt ? new Date(topic.updatedAt).toLocaleString() : ''}
                            </div>
                        </label>
                    </div>
                `;
            });
            
            html += '<button id="confirmImport">Import Selected</button>';
            el.searchResults.innerHTML = html;
            
            // Select all/none
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.import-checkbox').forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            document.getElementById('confirmImport').addEventListener('click', async () => {
                const selected = Array.from(document.querySelectorAll('.import-checkbox:checked'));
                if (selected.length === 0) return alert('No topics selected');
                
                const topicsToImport = newTopics.filter(t => 
                    selected.some(s => s.id === `imp-${t.id}`)
                ).map(topic => ({
                    ...topic,
                    // Ensure all required fields exist
                    id: topic.id || Date.now().toString(),
                    title: topic.title || 'Untitled',
                    content: topic.content || '',
                    category: topic.category || '',
                    updatedAt: topic.updatedAt || new Date().toISOString(),
                    createdAt: topic.createdAt || new Date().toISOString()
                }));
                
                try {
                    // Add to Firestore
                    const batch = db.batch();
                    const userRef = db.collection('users').doc(currentUser.uid);
                    
                    topicsToImport.forEach(topic => {
                        const topicRef = userRef.collection('topics').doc(topic.id);
                        batch.set(topicRef, {
                            title: topic.title,
                            content: topic.content,
                            category: topic.category,
                            createdAt: topic.createdAt,
                            updatedAt: topic.updatedAt
                        });
                        
                        // Add category if it doesn't exist
                        if (topic.category && !categories.includes(topic.category)) {
                            categories.push(topic.category);
                            const categoryRef = userRef.collection('categories').doc();
                            batch.set(categoryRef, { name: topic.category });
                        }
                    });
                    
                    await batch.commit();
                    
                    // Add to local data
                    topics = [...topics, ...topicsToImport];
                    
                    el.searchResults.innerHTML = `<p>Successfully imported ${topicsToImport.length} topics</p>`;
                    loadCategories();
                    displayTopics();
                    el.fileInput.value = '';
                } catch (error) {
                    console.error("Error importing topics:", error);
                    alert("Error importing topics. Please try again.");
                }
            });
        }

        // Search topics
        function searchTopics() {
            const query = el.searchInput.value.trim().toLowerCase();
            if (!query) {
                el.searchResults.innerHTML = '';
                return;
            }
            
            const results = topics.filter(topic => 
                (topic.title && topic.title.toLowerCase().includes(query)) || 
                (topic.content && topic.content.toLowerCase().includes(query)) ||
                (topic.category && topic.category.toLowerCase().includes(query))
            );
            
            if (results.length === 0) {
                el.searchResults.innerHTML = '<p>No results found</p>';
                return;
            }
            
            let html = '<h3>Search Results</h3>';
            results.forEach(topic => {
                html += `
                    <div class="topic-item" data-id="${topic.id}">
                        <div class="view-topic">
                            <strong>${topic.title}</strong>
                            <span class="topic-category">${topic.category || 'Uncategorized'}</span>
                            <div style="font-size:0.8em;color:#666;">
                                ${new Date(topic.updatedAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            el.searchResults.innerHTML = html;
            
            // Make search results clickable
            document.querySelectorAll('#searchResults .topic-item').forEach(item => {
                item.addEventListener('click', () => viewTopic(item.dataset.id));
            });
        }

        // Event Listeners
        el.saveBtn.addEventListener('click', saveTopic);
        el.newBtn.addEventListener('click', resetForm);
        el.deleteBtn.addEventListener('click', deleteTopic);
        el.addCategoryBtn.addEventListener('click', addCategory);
        el.exportAllBtn.addEventListener('click', exportAllTopics);
        el.exportSelectedBtn.addEventListener('click', exportSelectedTopics);
        el.importBtn.addEventListener('click', importTopics);
        el.searchBtn.addEventListener('click', searchTopics);
        el.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchTopics();
        });
        el.editTopicBtn.addEventListener('click', editTopic);
        el.closeViewerBtn.addEventListener('click', () => {
            el.topicViewer.style.display = 'none';
            document.getElementById('editor-container').style.display = 'block';
            quill.enable(true);
            document.querySelector('#editor-container .ql-toolbar').style.display = '';
            document.querySelector('#editor-container .ql-container').style.border = '';
        });

        // Show auth by default
        showAuth();
    </script>
</body>
</html>